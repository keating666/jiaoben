<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘çŒ«æ€§èƒ½è¯Šæ–­</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #0070f3;
        }
        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0051cc;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
            padding: 10px 15px;
            background: #e7f3ff;
            border-radius: 6px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #0070f3;
        }
        .recommendation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        .recommendation h4 {
            margin-top: 0;
            color: #856404;
        }
        .recommendation ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-bad { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ äº‘çŒ«æ€§èƒ½è¯Šæ–­å·¥å…·</h1>
        
        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="test-section">
            <h3>1. APIæ€§èƒ½æµ‹è¯•</h3>
            <button onclick="runPerformanceTest()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div id="perfLog" class="log"></div>
        </div>
        
        <!-- è§†é¢‘æºæµ‹è¯• -->
        <div class="test-section">
            <h3>2. è§†é¢‘æºå¯¹æ¯”æµ‹è¯•</h3>
            <button onclick="testVideo('china')">æµ‹è¯•å›½å†…CDNè§†é¢‘</button>
            <button onclick="testVideo('overseas')">æµ‹è¯•å›½å¤–CDNè§†é¢‘</button>
            <button onclick="testVideo('local')">æµ‹è¯•æœ¬åœ°å°è§†é¢‘</button>
            
            <div class="metric">
                <div class="metric-label">æäº¤å“åº”æ—¶é—´</div>
                <div class="metric-value" id="submitTime">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">æ€»å¤„ç†æ—¶é—´</div>
                <div class="metric-value" id="totalTime">-</div>
            </div>
            <div class="metric">
                <div class="metric-label">æŸ¥è¯¢æ¬¡æ•°</div>
                <div class="metric-value" id="queryCount">-</div>
            </div>
            
            <div id="videoLog" class="log"></div>
        </div>
        
        <!-- ä¼˜åŒ–å»ºè®® -->
        <div class="recommendation" id="recommendations" style="display: none;">
            <h4>ğŸ“‹ ä¼˜åŒ–å»ºè®®</h4>
            <ul id="recommendationList"></ul>
        </div>
    </div>
    
    <script>
        // ä¸åŒçš„è§†é¢‘æº
        const videoSources = {
            china: {
                url: 'https://vd3.bdstatic.com/mda-ih3tgx0p7xh5v3wa/hd/mda-ih3tgx0p7xh5v3wa.mp4', // ç™¾åº¦CDNç¤ºä¾‹
                name: 'å›½å†…CDNè§†é¢‘ï¼ˆç™¾åº¦ï¼‰',
                size: '~1MB'
            },
            overseas: {
                url: 'https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4',
                name: 'å›½å¤–CDNè§†é¢‘',
                size: '1MB'
            },
            local: {
                url: 'https://www.w3schools.com/html/mov_bbb.mp4',
                name: 'æå°æµ‹è¯•è§†é¢‘',
                size: '~200KB'
            }
        };
        
        let currentTaskId = null;
        let startTime = null;
        let queryCount = 0;
        
        function log(elementId, message, type = 'info') {
            const logEl = document.getElementById(elementId);
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'status-bad' : type === 'success' ? 'status-good' : '';
            logEl.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // è¿è¡Œæ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            log('perfLog', 'å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            
            try {
                const response = await fetch('/api/test-yunmao-performance');
                const data = await response.json();
                
                log('perfLog', `æ€»æµ‹è¯•æ—¶é—´: ${data.totalTime}`, 'success');
                
                data.tests.forEach(test => {
                    const status = test.status === 'pass' ? 'success' : 'error';
                    log('perfLog', `${test.name}: ${test.time} - ${test.details}`, status);
                });
                
                // æ˜¾ç¤ºå»ºè®®
                showRecommendations(data.recommendations);
                
            } catch (error) {
                log('perfLog', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•ä¸åŒè§†é¢‘æº
        async function testVideo(type) {
            const video = videoSources[type];
            log('videoLog', `æµ‹è¯• ${video.name} (${video.size})...`);
            
            // é‡ç½®è®¡æ•°å™¨
            queryCount = 0;
            document.getElementById('submitTime').textContent = '-';
            document.getElementById('totalTime').textContent = '-';
            document.getElementById('queryCount').textContent = '0';
            
            startTime = Date.now();
            
            try {
                // æäº¤ä»»åŠ¡
                const submitStart = Date.now();
                const response = await fetch('/api/video/submit-transcription-fetch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoUrl: video.url,
                        language: 'chinese'
                    })
                });
                
                const submitTime = Date.now() - submitStart;
                document.getElementById('submitTime').textContent = `${submitTime}ms`;
                
                const data = await response.json();
                if (data.success) {
                    currentTaskId = data.data.taskId;
                    log('videoLog', `ä»»åŠ¡æäº¤æˆåŠŸï¼ŒID: ${currentTaskId}`);
                    
                    // å¼€å§‹æŸ¥è¯¢
                    checkVideoStatus();
                } else {
                    log('videoLog', `æäº¤å¤±è´¥: ${data.error.message}`, 'error');
                }
                
            } catch (error) {
                log('videoLog', `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æŸ¥è¯¢çŠ¶æ€
        async function checkVideoStatus() {
            if (!currentTaskId) return;
            
            queryCount++;
            document.getElementById('queryCount').textContent = queryCount;
            
            try {
                const response = await fetch(`/api/video/check-transcription?taskId=${currentTaskId}`);
                const data = await response.json();
                
                if (data.success && data.data.status === 'completed') {
                    const totalTime = Date.now() - startTime;
                    document.getElementById('totalTime').textContent = `${Math.round(totalTime/1000)}s`;
                    
                    log('videoLog', `âœ… å®Œæˆï¼æ€»æ—¶é—´: ${Math.round(totalTime/1000)}ç§’ï¼ŒæŸ¥è¯¢${queryCount}æ¬¡`, 'success');
                    log('videoLog', `ç»“æœé¢„è§ˆ: ${data.data.text.substring(0, 50)}...`);
                    
                    // ç”Ÿæˆä¼˜åŒ–å»ºè®®
                    const recommendations = [];
                    if (totalTime > 60000) {
                        recommendations.push('å¤„ç†æ—¶é—´è¶…è¿‡60ç§’ï¼Œå»ºè®®ä½¿ç”¨æ›´å°çš„è§†é¢‘æˆ–å›½å†…CDN');
                    }
                    if (queryCount > 10) {
                        recommendations.push('æŸ¥è¯¢æ¬¡æ•°è¿‡å¤šï¼Œå¯èƒ½æ˜¯è§†é¢‘å¤„ç†æ—¶é—´è¿‡é•¿');
                    }
                    showRecommendations(recommendations);
                    
                } else {
                    // ç»§ç»­æŸ¥è¯¢
                    setTimeout(checkVideoStatus, 3000);
                }
                
            } catch (error) {
                log('videoLog', `æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
        function showRecommendations(recommendations) {
            if (recommendations.length > 0) {
                document.getElementById('recommendations').style.display = 'block';
                const list = document.getElementById('recommendationList');
                list.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');
            }
        }
        
        // é¡µé¢åŠ è½½
        window.onload = function() {
            log('perfLog', 'è¯Šæ–­å·¥å…·å‡†å¤‡å°±ç»ª');
            log('videoLog', 'è¯·é€‰æ‹©è§†é¢‘æºè¿›è¡Œæµ‹è¯•');
        };
    </script>
</body>
</html>