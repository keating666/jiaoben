name: Emergency Hotfix

on:
  push:
    branches: [ hotfix/* ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Emergency deployment reason'
        required: true
        type: string

env:
  NODE_VERSION: '18.x'

jobs:
  # Á¥ßÊÄ•‰øÆÂ§çÂø´ÈÄüÊ£ÄÊü•
  emergency-check:
    name: Emergency Quick Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies (fast)
      run: |
        cd tech-validation
        npm ci --prefer-offline --no-audit --no-fund
        
    - name: Quick lint check
      run: |
        cd tech-validation
        npm run lint -- --max-warnings 0
        
    - name: Quick type check
      run: |
        cd tech-validation
        npm run typecheck
        
    - name: Critical tests only
      run: |
        cd tech-validation
        npm run test:critical || npm test -- --testNamePattern="critical"
        
    - name: Build verification
      run: |
        cd tech-validation
        npm run build
        
  # Á¥ßÊÄ•ÈÉ®ÁΩ≤
  emergency-deploy:
    name: Emergency Deploy
    runs-on: ubuntu-latest
    needs: emergency-check
    environment:
      name: production-emergency
      url: https://tech-validation.vercel.app
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd tech-validation
        npm ci --production
        
    - name: Build for production
      run: |
        cd tech-validation
        npm run build
      env:
        NODE_ENV: production
        
    - name: Install Vercel CLI
      run: npm install --global vercel@latest
      
    - name: Deploy to Vercel (Emergency)
      run: |
        cd tech-validation
        DEPLOYMENT_URL=$(vercel --prod --confirm --token=${{ secrets.VERCEL_TOKEN }})
        echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
        
    - name: Create Emergency Deployment Record
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const reason = '${{ github.event.inputs.reason }}' || 'Hotfix deployment';
          const deployment = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'production-emergency',
            description: `Emergency: ${reason}`,
            auto_merge: false,
            required_contexts: []
          });
          
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: deployment.data.id,
            state: 'success',
            environment_url: process.env.DEPLOYMENT_URL,
            description: 'Emergency deployment successful'
          });
          
  # Á¥ßÊÄ•ÈÄöÁü•
  emergency-notification:
    name: Emergency Notification
    runs-on: ubuntu-latest
    needs: [emergency-check, emergency-deploy]
    if: always()
    
    steps:
    - name: Create emergency issue
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const status = '${{ needs.emergency-deploy.result }}';
          const reason = '${{ github.event.inputs.reason }}' || 'Hotfix deployment';
          const title = status === 'success' ? 
            'üö® Emergency Deployment Completed' : 
            '‚ùå Emergency Deployment Failed';
          const label = status === 'success' ? 'emergency-success' : 'emergency-failed';
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: `## Emergency Deployment Report
            
            **Reason**: ${reason}
            **Branch**: ${context.ref}
            **Commit**: ${context.sha}
            **Status**: ${status}
            **Time**: ${new Date().toISOString()}
            **Deployment URL**: ${process.env.DEPLOYMENT_URL || 'N/A'}
            
            ## Next Steps
            
            - [ ] Verify deployment is working correctly
            - [ ] Monitor for any issues
            - [ ] Create proper fix in develop branch
            - [ ] Document lessons learned
            - [ ] Update incident response procedures if needed
            `,
            labels: ['emergency', 'production', label, 'high-priority']
          });
          
    - name: Send Slack notification (if configured)
      if: always()
      run: |
        echo "üö® Emergency deployment notification sent"
        # Uncomment if Slack webhook is configured
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"üö® Emergency deployment: ${{ needs.emergency-deploy.result }}"}' \
        #   ${{ secrets.SLACK_EMERGENCY_WEBHOOK }}