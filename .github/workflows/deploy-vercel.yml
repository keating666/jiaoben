name: Deploy to Vercel

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [ main ]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: Install Vercel CLI
      run: npm install --global vercel@latest
      
    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: Build Project Artifacts
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: Deploy Preview to Vercel
      run: |
        DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
        echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
        
    - name: Comment PR with Preview URL
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `üöÄ Preview deployment ready!\n\nüîó Preview URL: ${process.env.DEPLOYMENT_URL}`
          })
          
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # Âè™Âú® CI ÊàêÂäüÂêéÈÉ®ÁΩ≤
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success' &&
      github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd tech-validation
        npm ci --production
        
    - name: Build project
      run: |
        cd tech-validation
        npm run build
      env:
        NODE_ENV: production
        
    - name: Install Vercel CLI
      run: npm install --global vercel@latest
      
    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: Build Project Artifacts for Vercel
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: Deploy to Vercel Production
      run: |
        DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
        echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV
        
    - name: Create GitHub Deployment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const deployment = await github.rest.repos.createDeployment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            environment: 'production',
            description: 'Vercel Production Deployment',
            auto_merge: false,
            required_contexts: []
          });
          
          await github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: deployment.data.id,
            state: 'success',
            environment_url: process.env.DEPLOYMENT_URL,
            description: 'Deployment successful'
          });
          
    - name: Purge CDN Cache
      run: |
        # Â¶ÇÊûú‰ΩøÁî® Cloudflare ÊàñÂÖ∂‰ªñ CDN
        echo "Purging CDN cache..."
        # curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
        #      -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
        #      -H "Content-Type: application/json" \
        #      --data '{"purge_everything":true}'
        
    - name: Run E2E Tests on Production
      run: |
        # Á≠âÂæÖÈÉ®ÁΩ≤ÂÆåÊàê
        sleep 30
        # ËøêË°å E2E ÊµãËØï
        cd tech-validation
        npm run test:e2e:prod || echo "E2E tests not configured yet"
      env:
        PRODUCTION_URL: ${{ env.DEPLOYMENT_URL }}
        
    - name: Send Deployment Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Production deployment successful: ${{ env.DEPLOYMENT_URL }}"
        else
          echo "‚ùå Production deployment failed"
        fi
        
  rollback:
    name: Rollback if Failed
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()
    
    steps:
    - name: Rollback to Previous Version
      run: |
        echo "Rolling back to previous version..."
        # vercel rollback --token=${{ secrets.VERCEL_TOKEN }}
        
    - name: Create Incident
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Production Deployment Failed',
            body: `Deployment to production failed and was rolled back.\n\nCommit: ${context.sha}\nWorkflow: ${context.workflow}`,
            labels: ['incident', 'production', 'high-priority']
          });