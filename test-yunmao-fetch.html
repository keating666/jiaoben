<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘çŒ«è½¬æ–‡å­—æµ‹è¯•ï¼ˆFetchç‰ˆï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0070f3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0051cc;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f0f0f0;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .result {
            margin-top: 20px;
            padding: 20px;
            background-color: #e7f3ff;
            border-radius: 5px;
            display: none;
        }
        .notice {
            background-color: #fffbeb;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ äº‘çŒ«è½¬æ–‡å­—æµ‹è¯•ï¼ˆFetchç‰ˆï¼‰</h1>
        
        <div class="notice">
            âš ï¸ ä½¿ç”¨Fetch APIç‰ˆæœ¬ï¼Œå¯èƒ½æ›´é€‚åˆVercelç¯å¢ƒ
        </div>
        
        <div style="background: #e7f3ff; border: 1px solid #0070f3; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h4 style="margin-top: 0; color: #0051cc;">âš¡ å¿«é€Ÿæµ‹è¯•é€‰é¡¹</h4>
            <button onclick="setQuickTest('tiny')" style="margin: 5px; padding: 8px 15px; background: #f0f0f0; color: #333; border: 1px solid #ddd;">
                5ç§’è§†é¢‘ (æœ€å¿«)
            </button>
            <button onclick="setQuickTest('small')" style="margin: 5px; padding: 8px 15px; background: #f0f0f0; color: #333; border: 1px solid #ddd;">
                10ç§’è§†é¢‘ (è¾ƒå¿«)
            </button>
            <button onclick="setQuickTest('default')" style="margin: 5px; padding: 8px 15px; background: #f0f0f0; color: #333; border: 1px solid #ddd;">
                é»˜è®¤è§†é¢‘ (30ç§’)
            </button>
        </div>
        
        <div class="input-group">
            <label for="videoUrl">è§†é¢‘é“¾æ¥ï¼š</label>
            <input type="text" id="videoUrl" 
                   placeholder="https://example.com/video.mp4" 
                   value="https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4">
            <small style="display: block; margin-top: 5px; color: #666;">
                é»˜è®¤ä½¿ç”¨æµ‹è¯•è§†é¢‘ï¼Œæ‚¨ä¹Ÿå¯ä»¥ç²˜è´´ TikHub è§£æçš„ URL
            </small>
        </div>
        
        <div class="input-group">
            <label for="language">è¯­è¨€ï¼š</label>
            <select id="language">
                <option value="chinese">ä¸­æ–‡</option>
                <option value="english">è‹±è¯­</option>
                <option value="guangdongChinese">ç²¤è¯­</option>
            </select>
        </div>
        
        <div>
            <button onclick="submitTask()" id="submitBtn">æ­¥éª¤1: æäº¤ä»»åŠ¡</button>
            <button onclick="checkStatus()" id="checkBtn" disabled>æ­¥éª¤2: æŸ¥è¯¢çŠ¶æ€</button>
            <button onclick="checkLogs()" style="background-color: #6b7280;">æŸ¥çœ‹æ—¥å¿—</button>
        </div>
        
        <div id="status"></div>
        <div id="result" class="result"></div>
    </div>

    <script>
        let currentTaskId = null;
        let checkInterval = null;
        let startTime = null;
        
        // æµ‹è¯•è§†é¢‘é€‰é¡¹
        const testVideos = {
            tiny: {
                url: 'https://www.w3schools.com/html/mov_bbb.mp4',
                name: '5ç§’æå°è§†é¢‘'
            },
            small: {
                url: 'https://sample-videos.com/video321/mp4/240/big_buck_bunny_240p_1mb.mp4',
                name: '10ç§’å°è§†é¢‘'
            },
            default: {
                url: 'https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4',
                name: '30ç§’æ ‡å‡†è§†é¢‘'
            }
        };
        
        function setQuickTest(type) {
            const video = testVideos[type];
            document.getElementById('videoUrl').value = video.url;
            log(`å·²é€‰æ‹©: ${video.name}`, 'info');
        }
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            status.innerHTML += `<span class="${type}">[${time}] ${message}</span>\n`;
            status.scrollTop = status.scrollHeight;
        }
        
        async function submitTask() {
            const videoUrl = document.getElementById('videoUrl').value;
            const language = document.getElementById('language').value;
            
            if (!videoUrl) {
                log('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }
            
            document.getElementById('submitBtn').disabled = true;
            startTime = Date.now();
            
            // æ£€æµ‹ä½¿ç”¨çš„è§†é¢‘ç±»å‹
            let videoType = 'è‡ªå®šä¹‰';
            for (const [key, video] of Object.entries(testVideos)) {
                if (video.url === videoUrl) {
                    videoType = video.name;
                    break;
                }
            }
            
            log(`æäº¤ä»»åŠ¡ä¸­ï¼ˆ${videoType}ï¼Œä½¿ç”¨Fetch APIï¼‰...`, 'info');
            
            try {
                const response = await fetch('/api/video/submit-transcription-fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUrl,
                        language,
                        chat: false
                    })
                });
                
                log(`å“åº”çŠ¶æ€: ${response.status}`, 'info');
                
                const data = await response.json();
                console.log('å®Œæ•´å“åº”:', data);
                
                if (data.success) {
                    currentTaskId = data.data.taskId;
                    log(`âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼ä»»åŠ¡ID: ${currentTaskId}`, 'success');
                    log('ç°åœ¨å¯ä»¥ç‚¹å‡»"æŸ¥è¯¢çŠ¶æ€"æŒ‰é’®', 'info');
                    
                    document.getElementById('checkBtn').disabled = false;
                    
                    // è‡ªåŠ¨å¼€å§‹å®šæœŸæ£€æŸ¥
                    startAutoCheck();
                } else {
                    log(`âŒ æäº¤å¤±è´¥: ${data.error.message}`, 'error');
                    if (data.error.code) {
                        log(`é”™è¯¯ä»£ç : ${data.error.code}`, 'error');
                    }
                    if (data.error.details) {
                        log(`è¯¦ç»†ä¿¡æ¯: ${JSON.stringify(data.error.details)}`, 'error');
                    }
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        }
        
        async function checkStatus() {
            if (!currentTaskId) {
                log('æ²¡æœ‰æœ‰æ•ˆçš„ä»»åŠ¡ID', 'error');
                return;
            }
            
            log('æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€...', 'info');
            
            try {
                const response = await fetch(`/api/video/check-transcription?taskId=${currentTaskId}`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data.status;
                    
                    if (status === 'completed') {
                        const totalTime = Math.round((Date.now() - startTime) / 1000);
                        log(`âœ… ä»»åŠ¡å®Œæˆï¼æ€»è€—æ—¶: ${totalTime} ç§’`, 'success');
                        displayResult(data.data.text);
                        stopAutoCheck();
                    } else if (status === 'processing') {
                        const elapsed = Math.round((Date.now() - startTime) / 1000);
                        log(`â³ ä»»åŠ¡å¤„ç†ä¸­... (å·²ç­‰å¾… ${elapsed} ç§’)`, 'info');
                    } else {
                        log(`çŠ¶æ€: ${status}`, 'info');
                    }
                } else {
                    log(`âŒ æŸ¥è¯¢å¤±è´¥: ${data.error.message}`, 'error');
                    stopAutoCheck();
                }
            } catch (error) {
                log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function checkLogs() {
            log('æŸ¥è¯¢äº‘çŒ«æ—¥å¿—...', 'info');
            
            try {
                const response = await fetch('/api/yunmao-logs');
                const data = await response.json();
                
                if (data.success) {
                    log(`æ‰¾åˆ° ${data.data.taskCount} ä¸ªä»»åŠ¡è®°å½•`, 'info');
                    if (data.data.taskCount > 0) {
                        Object.entries(data.data.results).forEach(([taskId, result]) => {
                            log(`ä»»åŠ¡ ${taskId}: ${result.status}`, result.status === 'completed' ? 'success' : 'error');
                        });
                    }
                } else {
                    log('è·å–æ—¥å¿—å¤±è´¥', 'error');
                }
            } catch (error) {
                log(`âŒ æŸ¥è¯¢æ—¥å¿—å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function startAutoCheck() {
            // æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
            // æ ¹æ®è§†é¢‘å¤§å°è°ƒæ•´æ£€æŸ¥é¢‘ç‡
            let intervalTime = 5000; // é»˜è®¤5ç§’
            if (document.getElementById('videoUrl').value === testVideos.tiny.url) {
                intervalTime = 2000; // æå°è§†é¢‘2ç§’
            } else if (document.getElementById('videoUrl').value === testVideos.small.url) {
                intervalTime = 3000; // å°è§†é¢‘3ç§’
            }
            
            checkInterval = setInterval(() => {
                checkStatus();
            }, intervalTime);
            
            log(`å·²å¯åŠ¨è‡ªåŠ¨æ£€æŸ¥ï¼ˆæ¯${intervalTime/1000}ç§’ï¼‰`, 'info');
        }
        
        function stopAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                log('å·²åœæ­¢è‡ªåŠ¨æ£€æŸ¥', 'info');
            }
        }
        
        function displayResult(text) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>è½¬å½•ç»“æœï¼š</h3>
                <p>${text}</p>
                <p><small>æ–‡æœ¬é•¿åº¦: ${text.length} å­—ç¬¦</small></p>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            log('å‡†å¤‡å°±ç»ªï¼ˆFetch APIç‰ˆæœ¬ï¼‰', 'success');
            log('æç¤ºï¼šæœ¬ç‰ˆæœ¬ä½¿ç”¨Fetch APIï¼Œå¯èƒ½æ›´é€‚åˆVercelç¯å¢ƒ', 'info');
        };
    </script>
</body>
</html>