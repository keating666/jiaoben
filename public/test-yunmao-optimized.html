<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘çŒ«è½¬æ–‡å­—ä¼˜åŒ–æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #0070f3;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0051cc;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f0f0f0;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .result {
            margin-top: 20px;
            padding: 20px;
            background-color: #e7f3ff;
            border-radius: 5px;
            display: none;
        }
        .test-videos {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .test-videos h3 {
            margin-top: 0;
            color: #92400e;
        }
        .video-option {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .video-option:hover {
            background: #fef3c7;
            transform: translateX(5px);
        }
        .video-option strong {
            color: #0070f3;
        }
        .timer {
            font-size: 18px;
            font-weight: bold;
            color: #0070f3;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0070f3 0%, #0051cc 100%);
            width: 0%;
            transition: width 0.5s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ äº‘çŒ«è½¬æ–‡å­—ä¼˜åŒ–æµ‹è¯•</h1>
        
        <div class="test-videos">
            <h3>âš¡ å¿«é€Ÿæµ‹è¯•è§†é¢‘ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</h3>
            <div class="video-option" onclick="selectVideo('tiny')">
                <strong>æå°è§†é¢‘ (5ç§’)</strong> - æœ€å¿«é€Ÿåº¦æµ‹è¯•
                <br><small>https://www.w3schools.com/html/mov_bbb.mp4</small>
            </div>
            <div class="video-option" onclick="selectVideo('small')">
                <strong>å°è§†é¢‘ (10ç§’)</strong> - å¿«é€Ÿæµ‹è¯•
                <br><small>https://sample-videos.com/video321/mp4/240/big_buck_bunny_240p_1mb.mp4</small>
            </div>
            <div class="video-option" onclick="selectVideo('medium')">
                <strong>ä¸­ç­‰è§†é¢‘ (30ç§’)</strong> - æ ‡å‡†æµ‹è¯•
                <br><small>https://sample-videos.com/video321/mp4/360/big_buck_bunny_360p_2mb.mp4</small>
            </div>
            <div class="video-option" onclick="selectVideo('custom')">
                <strong>è‡ªå®šä¹‰è§†é¢‘</strong> - è¾“å…¥æ‚¨çš„è§†é¢‘URL
            </div>
        </div>
        
        <div class="input-group">
            <label for="videoUrl">è§†é¢‘é“¾æ¥ï¼š</label>
            <input type="text" id="videoUrl" placeholder="é€‰æ‹©ä¸Šæ–¹æµ‹è¯•è§†é¢‘æˆ–è¾“å…¥è‡ªå®šä¹‰URL">
        </div>
        
        <div class="input-group">
            <label for="language">è¯­è¨€ï¼š</label>
            <select id="language">
                <option value="chinese">ä¸­æ–‡</option>
                <option value="english">è‹±è¯­</option>
                <option value="guangdongChinese">ç²¤è¯­</option>
            </select>
        </div>
        
        <div>
            <button onclick="submitTask()" id="submitBtn">ğŸš€ æäº¤ä»»åŠ¡</button>
            <button onclick="checkStatus()" id="checkBtn" disabled>ğŸ” æŸ¥è¯¢çŠ¶æ€</button>
            <button onclick="stopAutoCheck()" id="stopBtn" style="background-color: #ef4444; display: none;">â¹ï¸ åœæ­¢æ£€æŸ¥</button>
            <button onclick="clearAll()" style="background-color: #6b7280;">ğŸ”„ æ¸…ç©ºé‡ç½®</button>
        </div>
        
        <div class="timer" id="timer" style="display: none;">
            â±ï¸ å·²ç­‰å¾…: <span id="elapsed">0</span> ç§’
        </div>
        
        <div class="progress-bar" id="progressBar" style="display: none;">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div id="status"></div>
        <div id="result" class="result"></div>
    </div>

    <script>
        let currentTaskId = null;
        let checkInterval = null;
        let startTime = null;
        let timerInterval = null;
        
        const testVideos = {
            tiny: {
                url: 'https://www.w3schools.com/html/mov_bbb.mp4',
                duration: 5,
                size: '~200KB'
            },
            small: {
                url: 'https://sample-videos.com/video321/mp4/240/big_buck_bunny_240p_1mb.mp4',
                duration: 10,
                size: '1MB'
            },
            medium: {
                url: 'https://sample-videos.com/video321/mp4/360/big_buck_bunny_360p_2mb.mp4',
                duration: 30,
                size: '2MB'
            }
        };
        
        function selectVideo(type) {
            if (type === 'custom') {
                document.getElementById('videoUrl').value = '';
                document.getElementById('videoUrl').focus();
            } else {
                const video = testVideos[type];
                document.getElementById('videoUrl').value = video.url;
                log(`å·²é€‰æ‹©${type === 'tiny' ? 'æå°' : type === 'small' ? 'å°' : 'ä¸­ç­‰'}è§†é¢‘ (${video.duration}ç§’, ${video.size})`, 'info');
            }
        }
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“';
            status.innerHTML += `<span class="${type}">${icon} [${time}] ${message}</span>\n`;
            status.scrollTop = status.scrollHeight;
        }
        
        function startTimer() {
            startTime = Date.now();
            document.getElementById('timer').style.display = 'block';
            document.getElementById('progressBar').style.display = 'block';
            
            timerInterval = setInterval(() => {
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                document.getElementById('elapsed').textContent = elapsed;
                
                // æ›´æ–°è¿›åº¦æ¡ï¼ˆå‡è®¾æœ€é•¿120ç§’ï¼‰
                const progress = Math.min((elapsed / 120) * 100, 95);
                document.getElementById('progressFill').style.width = progress + '%';
            }, 100);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                document.getElementById('progressFill').style.width = '100%';
            }
        }
        
        async function submitTask() {
            const videoUrl = document.getElementById('videoUrl').value;
            const language = document.getElementById('language').value;
            
            if (!videoUrl) {
                log('è¯·é€‰æ‹©æˆ–è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }
            
            // æ£€æµ‹è§†é¢‘ç±»å‹
            let videoType = 'custom';
            for (const [key, video] of Object.entries(testVideos)) {
                if (video.url === videoUrl) {
                    videoType = key;
                    break;
                }
            }
            
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            log(`æäº¤ä»»åŠ¡ä¸­... (${videoType === 'custom' ? 'è‡ªå®šä¹‰' : videoType === 'tiny' ? 'æå°' : videoType === 'small' ? 'å°' : 'ä¸­ç­‰'}è§†é¢‘)`, 'info');
            
            startTimer();
            
            try {
                const response = await fetch('/api/video/submit-transcription-fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        videoUrl,
                        language,
                        chat: false
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTaskId = data.data.taskId;
                    log(`âœ… ä»»åŠ¡æäº¤æˆåŠŸï¼ä»»åŠ¡ID: ${currentTaskId}`, 'success');
                    
                    // æ ¹æ®è§†é¢‘å¤§å°ä¼°ç®—æ—¶é—´
                    let estimatedTime = 60;
                    if (videoType === 'tiny') estimatedTime = 20;
                    else if (videoType === 'small') estimatedTime = 40;
                    else if (videoType === 'medium') estimatedTime = 80;
                    
                    log(`é¢„è®¡å¤„ç†æ—¶é—´: ${estimatedTime} ç§’`, 'info');
                    
                    document.getElementById('checkBtn').disabled = false;
                    
                    // è‡ªåŠ¨å¼€å§‹æ£€æŸ¥
                    startAutoCheck();
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                log(`âŒ æäº¤å¤±è´¥: ${error.message}`, 'error');
                stopTimer();
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('stopBtn').style.display = 'none';
            }
        }
        
        async function checkStatus() {
            if (!currentTaskId) {
                log('æ²¡æœ‰æœ‰æ•ˆçš„ä»»åŠ¡ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/video/check-transcription?taskId=${currentTaskId}`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data.status;
                    
                    if (status === 'completed') {
                        stopTimer();
                        const totalTime = Math.round((Date.now() - startTime) / 1000);
                        log(`âœ… ä»»åŠ¡å®Œæˆï¼æ€»è€—æ—¶: ${totalTime} ç§’`, 'success');
                        displayResult(data.data.text);
                        stopAutoCheck();
                    } else if (status === 'processing') {
                        const elapsed = Math.round((Date.now() - startTime) / 1000);
                        log(`â³ ä»»åŠ¡å¤„ç†ä¸­... (å·²ç­‰å¾… ${elapsed} ç§’)`, 'info');
                    }
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                stopAutoCheck();
            }
        }
        
        function startAutoCheck() {
            // æ ¹æ®è§†é¢‘å¤§å°è°ƒæ•´æ£€æŸ¥é¢‘ç‡
            const videoUrl = document.getElementById('videoUrl').value;
            let checkIntervalTime = 5000; // é»˜è®¤5ç§’
            
            if (videoUrl === testVideos.tiny.url) {
                checkIntervalTime = 2000; // æå°è§†é¢‘2ç§’æ£€æŸ¥ä¸€æ¬¡
            } else if (videoUrl === testVideos.small.url) {
                checkIntervalTime = 3000; // å°è§†é¢‘3ç§’æ£€æŸ¥ä¸€æ¬¡
            }
            
            checkInterval = setInterval(() => {
                checkStatus();
            }, checkIntervalTime);
            
            log(`å·²å¯åŠ¨è‡ªåŠ¨æ£€æŸ¥ï¼ˆæ¯${checkIntervalTime/1000}ç§’ï¼‰`, 'info');
        }
        
        function stopAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                log('å·²åœæ­¢è‡ªåŠ¨æ£€æŸ¥', 'info');
            }
            stopTimer();
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'none';
        }
        
        function displayResult(text) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>âœ… è½¬å½•ç»“æœï¼š</h3>
                <p>${text || 'ï¼ˆæ— å†…å®¹ï¼‰'}</p>
                <p><small>æ–‡æœ¬é•¿åº¦: ${(text || '').length} å­—ç¬¦</small></p>
            `;
        }
        
        function clearAll() {
            stopAutoCheck();
            currentTaskId = null;
            document.getElementById('videoUrl').value = '';
            document.getElementById('status').innerHTML = '';
            document.getElementById('result').style.display = 'none';
            document.getElementById('timer').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('checkBtn').disabled = true;
            log('ç³»ç»Ÿå·²é‡ç½®', 'info');
        }
        
        // é¡µé¢åŠ è½½æ—¶
        window.onload = function() {
            log('ç³»ç»Ÿå‡†å¤‡å°±ç»ª', 'success');
            log('è¯·é€‰æ‹©æµ‹è¯•è§†é¢‘æˆ–è¾“å…¥è‡ªå®šä¹‰URL', 'info');
        };
    </script>
</body>
</html>