<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³è§†é¢‘è½¬æ–‡å­—å®Œæ•´æµç¨‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
        }
        .content {
            padding: 40px;
        }
        .workflow {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        .workflow::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step.active .step-circle {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .step.completed .step-circle {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        .step-title {
            font-size: 14px;
            color: #666;
        }
        .input-section {
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        button {
            flex: 1;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .status-section {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            min-height: 150px;
        }
        .status-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }
        .status-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #666;
            white-space: pre-wrap;
        }
        .result-section {
            display: none;
            background: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 10px;
            padding: 20px;
        }
        .result-title {
            color: #065f46;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .result-content {
            color: #064e3b;
            line-height: 1.6;
        }
        .error {
            color: #dc2626;
        }
        .success {
            color: #10b981;
        }
        .info {
            color: #3b82f6;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .examples {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .example-link {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
        }
        .example-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ æŠ–éŸ³è§†é¢‘è½¬æ–‡å­—å®Œæ•´æµç¨‹</h1>
            <p>TikHub é“¾æ¥è§£æ â†’ äº‘çŒ«è½¬ç  â†’ æ–‡å­—è¾“å‡º</p>
        </div>
        
        <div class="content">
            <!-- å·¥ä½œæµç¨‹æŒ‡ç¤ºå™¨ -->
            <div class="workflow">
                <div class="step" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-title">è¾“å…¥é“¾æ¥</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-title">è§£æè§†é¢‘</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-title">è½¬æ¢æ–‡å­—</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-title">è·å–ç»“æœ</div>
                </div>
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <div class="input-group">
                    <label for="douyinUrl">æŠ–éŸ³è§†é¢‘é“¾æ¥</label>
                    <input type="text" id="douyinUrl" 
                           placeholder="https://v.douyin.com/xxxxx æˆ–åˆ†äº«æ–‡æ¡ˆ" 
                           value="">
                    <div class="examples">
                        ç¤ºä¾‹: 
                        <a class="example-link" onclick="setExample('https://v.douyin.com/iRyBWfGS/')">çŸ­é“¾æ¥</a> | 
                        <a class="example-link" onclick="setExample('https://www.douyin.com/video/7123456789')">å®Œæ•´é“¾æ¥</a> |
                        <a class="example-link" onclick="setExample('æµ‹è¯•è§†é¢‘')">æµ‹è¯•è§†é¢‘</a>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="language">è¯†åˆ«è¯­è¨€</label>
                    <select id="language">
                        <option value="chinese">ä¸­æ–‡</option>
                        <option value="english">è‹±è¯­</option>
                        <option value="guangdongChinese">ç²¤è¯­</option>
                        <option value="sichuanChinese">å››å·è¯</option>
                        <option value="japanse">æ—¥è¯­</option>
                        <option value="korean">éŸ©è¯­</option>
                    </select>
                </div>
            </div>
            
            <!-- æŒ‰é’®åŒºåŸŸ -->
            <div class="button-group">
                <button class="btn-primary" onclick="processVideo()" id="processBtn">
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
                <button class="btn-secondary" onclick="clearAll()">
                    ğŸ”„ æ¸…ç©ºé‡ç½®
                </button>
            </div>
            
            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div class="status-section">
                <div class="status-title">å¤„ç†çŠ¶æ€</div>
                <div class="status-content" id="status">ç­‰å¾…å¼€å§‹...</div>
            </div>
            
            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-section" id="resultSection">
                <div class="result-title">âœ… è½¬å½•ç»“æœ</div>
                <div class="result-content" id="result"></div>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let checkInterval = null;
        let currentStep = 0;
        
        function setExample(url) {
            document.getElementById('douyinUrl').value = url;
        }
        
        function updateStep(step) {
            // æ¸…é™¤æ‰€æœ‰çŠ¶æ€
            document.querySelectorAll('.step').forEach(s => {
                s.classList.remove('active', 'completed');
            });
            
            // è®¾ç½®å®Œæˆå’Œå½“å‰çŠ¶æ€
            for (let i = 1; i < step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
            }
            if (step <= 4) {
                document.getElementById(`step${step}`).classList.add('active');
            }
            currentStep = step;
        }
        
        function log(message, type = 'info') {
            const status = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“';
            status.innerHTML += `<span class="${type}">${icon} [${time}] ${message}</span>\n`;
            status.scrollTop = status.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('status').innerHTML = '';
        }
        
        async function processVideo() {
            const douyinUrl = document.getElementById('douyinUrl').value.trim();
            const language = document.getElementById('language').value;
            
            if (!douyinUrl) {
                log('è¯·è¾“å…¥æŠ–éŸ³é“¾æ¥', 'error');
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            clearLog();
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            updateStep(1);
            
            try {
                log('å¼€å§‹å¤„ç†æŠ–éŸ³è§†é¢‘...', 'info');
                updateStep(2);
                
                // å¦‚æœæ˜¯"æµ‹è¯•è§†é¢‘"ï¼Œä½¿ç”¨æµ‹è¯•URL
                const isTest = douyinUrl === 'æµ‹è¯•è§†é¢‘';
                const requestUrl = isTest ? 
                    'https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4' : 
                    douyinUrl;
                
                log(isTest ? 'ä½¿ç”¨æµ‹è¯•è§†é¢‘...' : 'è§£ææŠ–éŸ³é“¾æ¥...', 'info');
                
                // è°ƒç”¨å¤„ç†API
                const response = await fetch('/api/douyin/process-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        douyinUrl: requestUrl,
                        language: language,
                        waitForResult: false // å¼‚æ­¥å¤„ç†
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTaskId = data.data.taskId;
                    log(`ä»»åŠ¡æäº¤æˆåŠŸï¼ä»»åŠ¡ID: ${currentTaskId}`, 'success');
                    log('è§†é¢‘URL: ' + data.data.videoUrl, 'info');
                    
                    updateStep(3);
                    log('æ­£åœ¨è½¬æ¢æ–‡å­—ï¼Œè¯·ç¨å€™...', 'info');
                    
                    // å¼€å§‹è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
                    startAutoCheck();
                } else {
                    throw new Error(data.error.message);
                }
                
            } catch (error) {
                log(`å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('processBtn').disabled = false;
                updateStep(0);
            }
        }
        
        async function checkStatus() {
            if (!currentTaskId) return;
            
            try {
                const response = await fetch(`/api/video/check-transcription?taskId=${currentTaskId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.status === 'completed') {
                        log('è½¬æ¢å®Œæˆï¼', 'success');
                        updateStep(4);
                        displayResult(data.data.text);
                        stopAutoCheck();
                        document.getElementById('processBtn').disabled = false;
                    } else if (data.data.status === 'processing') {
                        // ç»§ç»­ç­‰å¾…
                        if (!checkInterval) {
                            log('ä»»åŠ¡ä»åœ¨å¤„ç†ä¸­...', 'info');
                        }
                    }
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                log(`æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                stopAutoCheck();
                document.getElementById('processBtn').disabled = false;
            }
        }
        
        function startAutoCheck() {
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            checkStatus();
            
            // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
            checkInterval = setInterval(() => {
                checkStatus();
            }, 5000);
            
            log('å·²å¯åŠ¨è‡ªåŠ¨çŠ¶æ€æ£€æŸ¥ï¼ˆæ¯5ç§’ï¼‰', 'info');
        }
        
        function stopAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                log('å·²åœæ­¢è‡ªåŠ¨æ£€æŸ¥', 'info');
            }
        }
        
        function displayResult(text) {
            const resultSection = document.getElementById('resultSection');
            const result = document.getElementById('result');
            
            resultSection.style.display = 'block';
            result.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>è½¬å½•æ–‡æœ¬ï¼š</strong>
                </div>
                <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                    ${text || 'ï¼ˆæ— å†…å®¹ï¼‰'}
                </div>
                <div style="font-size: 14px; color: #666;">
                    æ–‡æœ¬é•¿åº¦: ${(text || '').length} å­—ç¬¦
                </div>
            `;
        }
        
        function clearAll() {
            stopAutoCheck();
            currentTaskId = null;
            document.getElementById('douyinUrl').value = '';
            document.getElementById('status').innerHTML = 'ç­‰å¾…å¼€å§‹...';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
            updateStep(0);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('ç³»ç»Ÿå‡†å¤‡å°±ç»ª', 'success');
            updateStep(1);
        };
    </script>
</body>
</html>