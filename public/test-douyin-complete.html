<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³è§†é¢‘æ™ºèƒ½è½¬æ–‡å­—ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .app-header {
            background: linear-gradient(135deg, #000000 0%, #333333 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .app-header h1 {
            text-align: center;
            font-size: 24px;
            font-weight: 500;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .workflow-step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            position: relative;
            z-index: 1;
            font-size: 18px;
            transition: all 0.3s;
        }
        
        .workflow-step.active .step-icon {
            background: #000;
            color: white;
        }
        
        .workflow-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #000;
            color: white;
        }
        
        .btn-primary:hover {
            background: #333;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .status-log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .log-entry {
            margin-bottom: 8px;
        }
        
        .log-time {
            color: #6c757d;
            margin-right: 8px;
        }
        
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
        .log-warning { color: #ffc107; }
        
        .result-box {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .result-title {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .result-content {
            background: white;
            padding: 16px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .examples {
            margin-top: 8px;
            font-size: 14px;
            color: #666;
        }
        
        .example-link {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .example-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>ğŸ¬ æŠ–éŸ³è§†é¢‘æ™ºèƒ½è½¬æ–‡å­—ç³»ç»Ÿ</h1>
    </div>
    
    <div class="container">
        <!-- å·¥ä½œæµç¨‹æŒ‡ç¤º -->
        <div class="workflow-steps">
            <div class="workflow-step" id="step1">
                <div class="step-icon">ğŸ“±</div>
                <div class="step-label">è¾“å…¥é“¾æ¥</div>
            </div>
            <div class="workflow-step" id="step2">
                <div class="step-icon">ğŸ”—</div>
                <div class="step-label">TikHubè§£æ</div>
            </div>
            <div class="workflow-step" id="step3">
                <div class="step-icon">ğŸ¥</div>
                <div class="step-label">äº‘çŒ«è½¬ç </div>
            </div>
            <div class="workflow-step" id="step4">
                <div class="step-icon">ğŸ“</div>
                <div class="step-label">æ–‡å­—è¾“å‡º</div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
            <div class="card">
                <h2 class="card-title">è§†é¢‘ä¿¡æ¯è¾“å…¥</h2>
                
                <div class="input-group">
                    <label for="douyinUrl">æŠ–éŸ³è§†é¢‘é“¾æ¥</label>
                    <input type="text" id="douyinUrl" 
                           placeholder="ç²˜è´´æŠ–éŸ³åˆ†äº«é“¾æ¥æˆ–è§†é¢‘ID">
                    <div class="examples">
                        å¿«é€Ÿæµ‹è¯•: 
                        <a class="example-link" onclick="setExample('test')">æµ‹è¯•è§†é¢‘</a>
                        <a class="example-link" onclick="setExample('https://v.douyin.com/iRyBWfGS/')">ç¤ºä¾‹é“¾æ¥</a>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="language">è¯†åˆ«è¯­è¨€</label>
                    <select id="language">
                        <option value="chinese">ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰</option>
                        <option value="guangdongChinese">ç²¤è¯­</option>
                        <option value="sichuanChinese">å››å·è¯</option>
                        <option value="english">è‹±è¯­</option>
                        <option value="japanse">æ—¥è¯­</option>
                        <option value="korean">éŸ©è¯­</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="waitForResult"> 
                        ç­‰å¾…å®Œæˆåè¿”å›ç»“æœï¼ˆå¯èƒ½éœ€è¦30-60ç§’ï¼‰
                    </label>
                </div>
                
                <div>
                    <button class="btn btn-primary" onclick="startProcess()" id="processBtn">
                        å¼€å§‹å¤„ç†
                    </button>
                    <button class="btn btn-secondary" onclick="resetAll()">
                        é‡ç½®
                    </button>
                </div>
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats" style="margin-top: 30px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRequests">0</div>
                        <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="successCount">0</div>
                        <div class="stat-label">æˆåŠŸæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTime">0s</div>
                        <div class="stat-label">å¹³å‡è€—æ—¶</div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šçŠ¶æ€å’Œç»“æœ -->
            <div>
                <div class="card">
                    <h2 class="card-title">å¤„ç†çŠ¶æ€</h2>
                    <div class="status-log" id="statusLog">
                        <div class="log-entry">
                            <span class="log-time">[å‡†å¤‡å°±ç»ª]</span>
                            <span class="log-info">ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œç­‰å¾…è¾“å…¥...</span>
                        </div>
                    </div>
                </div>
                
                <div class="result-box" id="resultBox">
                    <div class="result-title">âœ… è½¬å½•ç»“æœ</div>
                    <div class="result-content" id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡
        let currentTaskId = null;
        let checkInterval = null;
        let startTime = null;
        let stats = {
            total: 0,
            success: 0,
            totalTime: 0
        };
        
        // ä»localStorageåŠ è½½ç»Ÿè®¡
        function loadStats() {
            const saved = localStorage.getItem('videoStats');
            if (saved) {
                stats = JSON.parse(saved);
                updateStatsDisplay();
            }
        }
        
        // ä¿å­˜ç»Ÿè®¡
        function saveStats() {
            localStorage.setItem('videoStats', JSON.stringify(stats));
            updateStatsDisplay();
        }
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay() {
            document.getElementById('totalRequests').textContent = stats.total;
            document.getElementById('successCount').textContent = stats.success;
            const avgTime = stats.success > 0 ? Math.round(stats.totalTime / stats.success) : 0;
            document.getElementById('avgTime').textContent = avgTime + 's';
        }
        
        // è®¾ç½®ç¤ºä¾‹
        function setExample(value) {
            document.getElementById('douyinUrl').value = value;
        }
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(step) {
            document.querySelectorAll('.workflow-step').forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index < step - 1) {
                    el.classList.add('completed');
                } else if (index === step - 1) {
                    el.classList.add('active');
                }
            });
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const log = document.getElementById('statusLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
        }
        
        // å¼€å§‹å¤„ç†
        async function startProcess() {
            const url = document.getElementById('douyinUrl').value.trim();
            const language = document.getElementById('language').value;
            const waitForResult = document.getElementById('waitForResult').checked;
            
            if (!url) {
                addLog('è¯·è¾“å…¥æŠ–éŸ³è§†é¢‘é“¾æ¥', 'error');
                return;
            }
            
            // é‡ç½®çŠ¶æ€
            clearLog();
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('processBtn').disabled = true;
            updateStep(1);
            
            // è®°å½•å¼€å§‹æ—¶é—´
            startTime = Date.now();
            stats.total++;
            
            try {
                addLog('å¼€å§‹å¤„ç†è§†é¢‘...', 'info');
                updateStep(2);
                
                // å¤„ç†æµ‹è¯•è§†é¢‘
                const isTest = url === 'test';
                const requestUrl = isTest ? 
                    'https://sample-videos.com/video321/mp4/720/big_buck_bunny_720p_1mb.mp4' : 
                    url;
                
                addLog(isTest ? 'ä½¿ç”¨æµ‹è¯•è§†é¢‘' : 'æ­£åœ¨é€šè¿‡TikHubè§£æè§†é¢‘...', 'info');
                
                // è°ƒç”¨API
                const response = await fetch('/api/douyin/process-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        douyinUrl: requestUrl,
                        language: language,
                        waitForResult: waitForResult
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTaskId = data.data.taskId;
                    addLog(`ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼ŒID: ${currentTaskId}`, 'success');
                    
                    if (data.data.status === 'completed') {
                        // ç›´æ¥è¿”å›äº†ç»“æœ
                        updateStep(4);
                        displayResult(data.data.text);
                        recordSuccess();
                    } else {
                        // éœ€è¦è½®è¯¢çŠ¶æ€
                        updateStep(3);
                        addLog('äº‘çŒ«æ­£åœ¨è½¬ç å¤„ç†ï¼Œè¯·ç¨å€™...', 'info');
                        startStatusCheck();
                    }
                } else {
                    throw new Error(data.error.message);
                }
                
            } catch (error) {
                addLog(`å¤„ç†å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('processBtn').disabled = false;
                updateStep(0);
            }
        }
        
        // å¼€å§‹çŠ¶æ€æ£€æŸ¥
        function startStatusCheck() {
            checkStatus(); // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            checkInterval = setInterval(checkStatus, 5000); // æ¯5ç§’æ£€æŸ¥
        }
        
        // åœæ­¢çŠ¶æ€æ£€æŸ¥
        function stopStatusCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
        }
        
        // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
        async function checkStatus() {
            if (!currentTaskId) return;
            
            try {
                const response = await fetch(`/api/video/check-transcription?taskId=${currentTaskId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.status === 'completed') {
                        updateStep(4);
                        addLog('è½¬æ¢å®Œæˆï¼', 'success');
                        displayResult(data.data.text);
                        stopStatusCheck();
                        recordSuccess();
                        document.getElementById('processBtn').disabled = false;
                    } else if (data.data.status === 'processing') {
                        // ç»§ç»­ç­‰å¾…
                        const elapsed = Math.round((Date.now() - startTime) / 1000);
                        addLog(`å¤„ç†ä¸­... (å·²ç­‰å¾… ${elapsed} ç§’)`, 'info');
                    }
                } else {
                    throw new Error(data.error.message);
                }
            } catch (error) {
                addLog(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                stopStatusCheck();
                document.getElementById('processBtn').disabled = false;
            }
        }
        
        // æ˜¾ç¤ºç»“æœ
        function displayResult(text) {
            const resultBox = document.getElementById('resultBox');
            const resultContent = document.getElementById('resultContent');
            
            resultBox.style.display = 'block';
            resultContent.innerHTML = `
                <div style="white-space: pre-wrap;">${text || 'ï¼ˆæ— å†…å®¹ï¼‰'}</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; color: #666;">
                    æ–‡æœ¬é•¿åº¦: ${(text || '').length} å­—ç¬¦
                </div>
            `;
        }
        
        // è®°å½•æˆåŠŸ
        function recordSuccess() {
            stats.success++;
            const elapsed = Math.round((Date.now() - startTime) / 1000);
            stats.totalTime += elapsed;
            saveStats();
            addLog(`æ€»è€—æ—¶: ${elapsed} ç§’`, 'info');
        }
        
        // é‡ç½®æ‰€æœ‰
        function resetAll() {
            stopStatusCheck();
            currentTaskId = null;
            document.getElementById('douyinUrl').value = '';
            clearLog();
            addLog('ç³»ç»Ÿå·²é‡ç½®', 'info');
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
            updateStep(1);
        }
        
        // é¡µé¢åŠ è½½
        window.onload = function() {
            loadStats();
            updateStep(1);
            addLog('ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œç­‰å¾…è¾“å…¥...', 'info');
        };
    </script>
</body>
</html>