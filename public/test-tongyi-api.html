<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šä¹‰åƒé—® API æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .status-bar {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            animation: pulse 2s infinite;
        }
        
        .status-dot.online {
            background: #4ade80;
        }
        
        .status-dot.error {
            background: #f87171;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #764ba2;
        }
        
        .input-group textarea {
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-area.streaming {
            border-color: #667eea;
            background: linear-gradient(to bottom, #f0f9ff, #f9fafb);
        }
        
        .result-area.error {
            border-color: #f87171;
            background: #fef2f2;
            color: #991b1b;
        }
        
        .result-area.success {
            border-color: #4ade80;
            background: #f0fdf4;
        }
        
        .result-area pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        .config-panel {
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .config-row input {
            flex: 1;
        }
        
        .test-cases {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        
        .test-case {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .test-case:hover {
            background: #e5e7eb;
        }
        
        .test-case-title {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }
        
        .test-case-desc {
            font-size: 12px;
            color: #6b7280;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-top-color: #764ba2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .chart-container {
            height: 200px;
            margin-top: 20px;
            position: relative;
        }
        
        .performance-bar {
            display: flex;
            height: 30px;
            background: #f3f4f6;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .performance-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 500;
            transition: width 0.5s ease;
        }
        
        .segment-good {
            background: #4ade80;
        }
        
        .segment-warning {
            background: #fbbf24;
        }
        
        .segment-bad {
            background: #f87171;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ é€šä¹‰åƒé—® API æµ‹è¯•æ§åˆ¶å°</h1>
            <p>æµ‹è¯•æ–‡æœ¬ç”Ÿæˆå’Œè„šæœ¬æ”¹å†™åŠŸèƒ½ | Vercel Serverless Functions</p>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
            <div>
                <span id="apiEndpoint">é…ç½® API ç«¯ç‚¹...</span>
            </div>
        </div>

        <div class="config-panel">
            <div class="config-row">
                <input type="text" id="apiUrl" placeholder="API åŸºç¡€ URL" value="https://jiaoben-7jx4.vercel.app">
                <input type="password" id="apiKey" placeholder="API Key" value="default-key">
                <button class="btn btn-secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- æ–‡æœ¬ç”Ÿæˆ -->
            <div class="card">
                <h2>ğŸ“ æ–‡æœ¬ç”Ÿæˆ</h2>
                
                <div class="input-group">
                    <label>ç³»ç»Ÿæç¤ºï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="systemPrompt" placeholder="ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©çš„åŠ©æ‰‹...">
                </div>
                
                <div class="input-group">
                    <label>ç”¨æˆ·è¾“å…¥</label>
                    <textarea id="userInput" rows="4" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æç¤ºè¯...">è¯·ç”¨ç®€æ´çš„è¯­è¨€è§£é‡Šä»€ä¹ˆæ˜¯äººå·¥æ™ºèƒ½ã€‚</textarea>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>æ¨¡å‹</label>
                        <select id="model">
                            <option value="qwen-max">qwen-max</option>
                            <option value="qwen-plus">qwen-plus</option>
                            <option value="qwen-turbo">qwen-turbo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>æ¸©åº¦</label>
                        <input type="number" id="temperature" value="0.7" min="0" max="1" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>æœ€å¤§ä»¤ç‰Œ</label>
                        <input type="number" id="maxTokens" value="500" min="1" max="2000">
                    </div>
                </div>
                
                <div class="test-cases">
                    <div class="test-case" onclick="loadTextExample('explain')">
                        <div class="test-case-title">ğŸ’¡ è§£é‡Šæ¦‚å¿µ</div>
                        <div class="test-case-desc">è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†</div>
                    </div>
                    <div class="test-case" onclick="loadTextExample('creative')">
                        <div class="test-case-title">ğŸ¨ åˆ›æ„å†™ä½œ</div>
                        <div class="test-case-desc">å†™ä¸€ä¸ªå…³äºæœªæ¥åŸå¸‚çš„çŸ­æ•…äº‹å¼€å¤´</div>
                    </div>
                    <div class="test-case" onclick="loadTextExample('code')">
                        <div class="test-case-title">ğŸ’» ä»£ç ç”Ÿæˆ</div>
                        <div class="test-case-desc">ç”Ÿæˆå¿«é€Ÿæ’åºç®—æ³•çš„Pythonå®ç°</div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="generateText(false)">
                        <span>ğŸ¯</span> ç”Ÿæˆæ–‡æœ¬
                    </button>
                    <button class="btn btn-primary" onclick="generateText(true)">
                        <span>âš¡</span> æµå¼ç”Ÿæˆ
                    </button>
                </div>
                
                <div id="textResult" class="result-area" style="display:none;">
                    <pre id="textContent"></pre>
                </div>
                
                <div id="textMetrics" class="metrics" style="display:none;">
                    <div class="metric-card">
                        <div class="metric-value" id="textTime">-</div>
                        <div class="metric-label">å“åº”æ—¶é—´(ms)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="textTokens">-</div>
                        <div class="metric-label">ç”Ÿæˆä»¤ç‰Œ</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="textChars">-</div>
                        <div class="metric-label">å­—ç¬¦æ•°</div>
                    </div>
                </div>
            </div>

            <!-- è„šæœ¬æ”¹å†™ -->
            <div class="card">
                <h2>ğŸ¬ è„šæœ¬æ”¹å†™</h2>
                
                <div class="input-group">
                    <label>åŸå§‹è„šæœ¬</label>
                    <textarea id="originalScript" rows="6" placeholder="è¾“å…¥è¦æ”¹å†™çš„è„šæœ¬...">å¤§å®¶å¥½ï¼Œä»Šå¤©ç»™å¤§å®¶åˆ†äº«ä¸€ä¸ªç”Ÿæ´»å°æŠ€å·§ã€‚å½“æˆ‘ä»¬åœ¨å®¶åšé¥­æ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°æ´‹è‘±åˆ‡å¾—çœ¼æ³ªç›´æµçš„é—®é¢˜ã€‚å…¶å®æœ‰ä¸€ä¸ªç®€å•çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨åˆ‡æ´‹è‘±ä¹‹å‰ï¼Œå…ˆæŠŠæ´‹è‘±æ”¾åœ¨å†°ç®±é‡Œå†·è—15åˆ†é’Ÿï¼Œæˆ–è€…åœ¨åˆ‡çš„æ—¶å€™æ—è¾¹æ”¾ä¸€ç¢—æ°´ï¼Œè¿™æ ·åˆ‡çš„æ—¶å€™å°±ä¸ä¼šæµæ³ªäº†ã€‚å¸Œæœ›è¿™ä¸ªå°æŠ€å·§å¯¹å¤§å®¶æœ‰å¸®åŠ©ï¼</textarea>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>é£æ ¼</label>
                        <select id="scriptStyle">
                            <option value="humorous">å¹½é»˜é£è¶£</option>
                            <option value="educational">æ•™è‚²ç§‘æ™®</option>
                            <option value="emotional">æƒ…æ„Ÿä¸°å¯Œ</option>
                            <option value="professional">ä¸“ä¸šæ­£å¼</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ç›®æ ‡é•¿åº¦</label>
                        <input type="number" id="targetLength" placeholder="å¯é€‰">
                    </div>
                    <div class="input-group">
                        <label>ç‰¹æ®Šè¦æ±‚</label>
                        <input type="text" id="additionalReq" placeholder="å¯é€‰">
                    </div>
                </div>
                
                <div class="test-cases">
                    <div class="test-case" onclick="loadScriptExample('product')">
                        <div class="test-case-title">ğŸ›ï¸ äº§å“ä»‹ç»</div>
                        <div class="test-case-desc">æ™ºèƒ½æ‰‹è¡¨äº§å“ä»‹ç»è„šæœ¬</div>
                    </div>
                    <div class="test-case" onclick="loadScriptExample('tutorial')">
                        <div class="test-case-title">ğŸ“š æ•™ç¨‹è„šæœ¬</div>
                        <div class="test-case-desc">æ‘„å½±æŠ€å·§æ•™å­¦è„šæœ¬</div>
                    </div>
                    <div class="test-case" onclick="loadScriptExample('story')">
                        <div class="test-case-title">ğŸ“– æ•…äº‹è„šæœ¬</div>
                        <div class="test-case-desc">åŠ±å¿—æ•…äº‹åˆ†äº«è„šæœ¬</div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="rewriteScript(false)">
                        <span>âœï¸</span> æ”¹å†™è„šæœ¬
                    </button>
                    <button class="btn btn-primary" onclick="rewriteScript(true)">
                        <span>ğŸŒŠ</span> æµå¼æ”¹å†™
                    </button>
                </div>
                
                <div id="scriptResult" class="result-area" style="display:none;">
                    <pre id="scriptContent"></pre>
                </div>
                
                <div id="scriptMetrics" class="metrics" style="display:none;">
                    <div class="metric-card">
                        <div class="metric-value" id="scriptTime">-</div>
                        <div class="metric-label">å¤„ç†æ—¶é—´(ms)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="scriptLength">-</div>
                        <div class="metric-label">å­—ç¬¦æ•°</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="scriptStyleApplied">-</div>
                        <div class="metric-label">åº”ç”¨é£æ ¼</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½æµ‹è¯• -->
        <div class="card">
            <h2>âš¡ æ€§èƒ½æµ‹è¯•</h2>
            
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="runPerformanceTest()">
                    è¿è¡Œæ€§èƒ½æµ‹è¯•
                </button>
                <button class="btn btn-secondary" onclick="runConcurrentTest()">
                    å¹¶å‘æµ‹è¯• (10è¯·æ±‚)
                </button>
                <button class="btn btn-secondary" onclick="runStressTest()">
                    å‹åŠ›æµ‹è¯•
                </button>
            </div>
            
            <div id="performanceResult" class="result-area" style="display:none; margin-top: 20px;">
                <pre id="performanceContent"></pre>
            </div>
            
            <div class="chart-container" id="performanceChart" style="display:none;">
                <div class="performance-bar" id="perfBar"></div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const getApiUrl = () => document.getElementById('apiUrl').value;
        const getApiKey = () => document.getElementById('apiKey').value;
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(online, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const endpoint = document.getElementById('apiEndpoint');
            
            dot.className = 'status-dot ' + (online ? 'online' : 'error');
            statusText.textContent = text;
            endpoint.textContent = getApiUrl();
        }
        
        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            updateStatus(false, 'æµ‹è¯•è¿æ¥ä¸­...');
            
            try {
                const response = await fetch(`${getApiUrl()}/api/tongyi/text-generation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getApiKey()}`
                    },
                    body: JSON.stringify({
                        messages: [{ role: 'user', content: 'test' }],
                        max_tokens: 1
                    })
                });
                
                if (response.ok) {
                    updateStatus(true, 'è¿æ¥æˆåŠŸ');
                } else {
                    updateStatus(false, `è¿æ¥å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                updateStatus(false, `è¿æ¥é”™è¯¯: ${error.message}`);
            }
        }
        
        // åŠ è½½æ–‡æœ¬ç¤ºä¾‹
        function loadTextExample(type) {
            const examples = {
                explain: "è¯·ç”¨ç®€å•æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†ï¼Œå¹¶ä¸¾ä¾‹è¯´æ˜å®ƒä¸ä¼ ç»Ÿè®¡ç®—çš„åŒºåˆ«ã€‚",
                creative: "å†™ä¸€ä¸ªå…³äº2050å¹´æœªæ¥åŸå¸‚çš„çŸ­æ•…äº‹å¼€å¤´ï¼Œæè¿°ä¸»äººå…¬ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™åº§åŸå¸‚çš„åœºæ™¯ï¼Œè¦æœ‰ç”»é¢æ„Ÿã€‚",
                code: "è¯·ç”Ÿæˆä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•çš„Pythonå®ç°ï¼ŒåŒ…å«è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜æ¯ä¸€æ­¥çš„ä½œç”¨ã€‚"
            };
            
            document.getElementById('userInput').value = examples[type];
        }
        
        // åŠ è½½è„šæœ¬ç¤ºä¾‹
        function loadScriptExample(type) {
            const examples = {
                product: "è¿™æ¬¾æ™ºèƒ½æ‰‹è¡¨ä¸ä»…èƒ½ç›‘æµ‹æ‚¨çš„å¥åº·æ•°æ®ï¼Œè¿˜èƒ½æ¥æ‰“ç”µè¯ã€æ”¯ä»˜è´­ç‰©ï¼Œç»­èˆªé•¿è¾¾7å¤©ã€‚å®ƒé‡‡ç”¨äº†æœ€æ–°çš„èŠ¯ç‰‡æŠ€æœ¯ï¼Œå“åº”é€Ÿåº¦æå‡50%ã€‚æ— è®ºæ‚¨æ˜¯è¿åŠ¨çˆ±å¥½è€…è¿˜æ˜¯å•†åŠ¡äººå£«ï¼Œéƒ½èƒ½æ‰¾åˆ°é€‚åˆçš„åŠŸèƒ½ã€‚",
                tutorial: "ä»Šå¤©æ•™å¤§å®¶ä¸€ä¸ªæ‘„å½±å°æŠ€å·§ï¼šé»„é‡‘æ—¶åˆ»æ‹æ‘„ã€‚æ—¥å‡ºåå’Œæ—¥è½å‰çš„ä¸€å°æ—¶ï¼Œå…‰çº¿æŸ”å’Œæ¸©æš–ï¼Œæ˜¯æ‹æ‘„äººåƒçš„æœ€ä½³æ—¶æœºã€‚è®°å¾—è®©ä¸»ä½“èƒŒå¯¹å¤ªé˜³ï¼Œè¿™æ ·èƒ½è·å¾—æŸ”ç¾çš„è½®å»“å…‰ã€‚",
                story: "5å¹´å‰ï¼Œæˆ‘è¿˜æ˜¯ä¸€ä¸ªæ™®é€šçš„ä¸Šç­æ—ï¼Œæ¯å¤©æœä¹æ™šäº”ã€‚ç›´åˆ°é‚£å¤©ï¼Œæˆ‘å†³å®šè¿½éšè‡ªå·±çš„æ¢¦æƒ³ï¼Œè¾èŒåˆ›ä¸šã€‚è™½ç„¶è·¯é€”è‰°è¾›ï¼Œä½†æˆ‘ä»æœªåæ‚”ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³å’Œå¤§å®¶åˆ†äº«è¿™æ®µç»å†ã€‚"
            };
            
            document.getElementById('originalScript').value = examples[type];
        }
        
        // æ–‡æœ¬ç”Ÿæˆ
        async function generateText(streaming) {
            const resultDiv = document.getElementById('textResult');
            const contentDiv = document.getElementById('textContent');
            const metricsDiv = document.getElementById('textMetrics');
            
            resultDiv.style.display = 'block';
            resultDiv.className = streaming ? 'result-area streaming' : 'result-area';
            contentDiv.textContent = 'ç”Ÿæˆä¸­...';
            
            const systemPrompt = document.getElementById('systemPrompt').value;
            const userInput = document.getElementById('userInput').value;
            const model = document.getElementById('model').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            
            const messages = [];
            if (systemPrompt) {
                messages.push({ role: 'system', content: systemPrompt });
            }
            messages.push({ role: 'user', content: userInput });
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${getApiUrl()}/api/tongyi/text-generation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getApiKey()}`
                    },
                    body: JSON.stringify({
                        messages,
                        model,
                        temperature,
                        max_tokens: maxTokens,
                        stream: streaming
                    })
                });
                
                if (streaming) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    contentDiv.textContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const chunk = JSON.parse(data);
                                    if (chunk.content) {
                                        contentDiv.textContent = chunk.content;
                                    }
                                    if (chunk.done && chunk.usage) {
                                        showTextMetrics(Date.now() - startTime, chunk.usage.completion_tokens, chunk.content.length);
                                    }
                                } catch (e) {
                                    console.error('Parse error:', e);
                                }
                            }
                        }
                    }
                    
                    resultDiv.className = 'result-area success';
                } else {
                    const data = await response.json();
                    
                    if (data.success) {
                        contentDiv.textContent = data.data.content;
                        resultDiv.className = 'result-area success';
                        showTextMetrics(Date.now() - startTime, data.data.usage.completion_tokens, data.data.content.length);
                    } else {
                        throw new Error(data.error);
                    }
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                contentDiv.textContent = `é”™è¯¯: ${error.message}`;
                metricsDiv.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºæ–‡æœ¬ç”ŸæˆæŒ‡æ ‡
        function showTextMetrics(time, tokens, chars) {
            const metricsDiv = document.getElementById('textMetrics');
            document.getElementById('textTime').textContent = time;
            document.getElementById('textTokens').textContent = tokens || '-';
            document.getElementById('textChars').textContent = chars;
            metricsDiv.style.display = 'grid';
        }
        
        // è„šæœ¬æ”¹å†™
        async function rewriteScript(streaming) {
            const resultDiv = document.getElementById('scriptResult');
            const contentDiv = document.getElementById('scriptContent');
            const metricsDiv = document.getElementById('scriptMetrics');
            
            resultDiv.style.display = 'block';
            resultDiv.className = streaming ? 'result-area streaming' : 'result-area';
            contentDiv.textContent = 'æ”¹å†™ä¸­...';
            
            const originalScript = document.getElementById('originalScript').value;
            const style = document.getElementById('scriptStyle').value;
            const targetLength = document.getElementById('targetLength').value;
            const additionalReq = document.getElementById('additionalReq').value;
            
            const startTime = Date.now();
            
            try {
                const requestBody = {
                    original_script: originalScript,
                    style,
                    stream: streaming
                };
                
                if (targetLength) {
                    requestBody.target_length = parseInt(targetLength);
                }
                if (additionalReq) {
                    requestBody.additional_requirements = additionalReq;
                }
                
                const response = await fetch(`${getApiUrl()}/api/tongyi/script-rewrite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getApiKey()}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (streaming) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    contentDiv.textContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const chunk = JSON.parse(data);
                                    if (chunk.content) {
                                        contentDiv.textContent += chunk.content;
                                    }
                                } catch (e) {
                                    console.error('Parse error:', e);
                                }
                            }
                        }
                    }
                    
                    resultDiv.className = 'result-area success';
                    showScriptMetrics(Date.now() - startTime, contentDiv.textContent.length, style);
                } else {
                    const data = await response.json();
                    
                    if (data.success) {
                        contentDiv.textContent = `ã€æ”¹å†™åçš„è„šæœ¬ã€‘\n${data.data.rewritten_script}\n\nã€æ”¹åŠ¨è¯´æ˜ã€‘\n${data.data.changes_summary}`;
                        resultDiv.className = 'result-area success';
                        showScriptMetrics(data.data.processing_time, data.data.character_count, data.data.style_applied);
                    } else {
                        throw new Error(data.error);
                    }
                }
            } catch (error) {
                resultDiv.className = 'result-area error';
                contentDiv.textContent = `é”™è¯¯: ${error.message}`;
                metricsDiv.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºè„šæœ¬æ”¹å†™æŒ‡æ ‡
        function showScriptMetrics(time, length, style) {
            const metricsDiv = document.getElementById('scriptMetrics');
            document.getElementById('scriptTime').textContent = time;
            document.getElementById('scriptLength').textContent = length;
            document.getElementById('scriptStyleApplied').textContent = style;
            metricsDiv.style.display = 'grid';
        }
        
        // æ€§èƒ½æµ‹è¯•
        async function runPerformanceTest() {
            const resultDiv = document.getElementById('performanceResult');
            const contentDiv = document.getElementById('performanceContent');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-area';
            contentDiv.textContent = 'è¿è¡Œæ€§èƒ½æµ‹è¯•...\n\n';
            
            const tests = [
                { name: 'çŸ­æ–‡æœ¬ç”Ÿæˆ (100 tokens)', tokens: 100 },
                { name: 'ä¸­æ–‡æœ¬ç”Ÿæˆ (500 tokens)', tokens: 500 },
                { name: 'é•¿æ–‡æœ¬ç”Ÿæˆ (1000 tokens)', tokens: 1000 }
            ];
            
            const results = [];
            
            for (const test of tests) {
                const startTime = Date.now();
                
                try {
                    const response = await fetch(`${getApiUrl()}/api/tongyi/text-generation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getApiKey()}`
                        },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: 'ç”Ÿæˆä¸€æ®µæµ‹è¯•æ–‡æœ¬' }],
                            max_tokens: test.tokens
                        })
                    });
                    
                    const data = await response.json();
                    const elapsed = Date.now() - startTime;
                    
                    const status = elapsed < 3000 ? 'âœ…' : elapsed < 5000 ? 'âš ï¸' : 'âŒ';
                    contentDiv.textContent += `${status} ${test.name}: ${elapsed}ms\n`;
                    
                    results.push({ name: test.name, time: elapsed });
                } catch (error) {
                    contentDiv.textContent += `âŒ ${test.name}: å¤±è´¥ - ${error.message}\n`;
                }
                
                // é¿å…é€Ÿç‡é™åˆ¶
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            contentDiv.textContent += '\næµ‹è¯•å®Œæˆï¼\n';
            showPerformanceChart(results);
        }
        
        // å¹¶å‘æµ‹è¯•
        async function runConcurrentTest() {
            const resultDiv = document.getElementById('performanceResult');
            const contentDiv = document.getElementById('performanceContent');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-area';
            contentDiv.textContent = 'è¿è¡Œå¹¶å‘æµ‹è¯• (10ä¸ªè¯·æ±‚)...\n\n';
            
            const startTime = Date.now();
            const promises = [];
            
            for (let i = 0; i < 10; i++) {
                promises.push(
                    fetch(`${getApiUrl()}/api/tongyi/text-generation`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getApiKey()}`
                        },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: `å¹¶å‘æµ‹è¯•è¯·æ±‚ ${i + 1}` }],
                            max_tokens: 50
                        })
                    }).then(r => r.json())
                );
            }
            
            const results = await Promise.allSettled(promises);
            const elapsed = Date.now() - startTime;
            
            let successCount = 0;
            let failCount = 0;
            
            results.forEach((result, index) => {
                if (result.status === 'fulfilled' && result.value.success) {
                    successCount++;
                } else {
                    failCount++;
                }
            });
            
            contentDiv.textContent += `å®Œæˆï¼\n`;
            contentDiv.textContent += `æ€»æ—¶é—´: ${elapsed}ms\n`;
            contentDiv.textContent += `æˆåŠŸ: ${successCount}/10\n`;
            contentDiv.textContent += `å¤±è´¥: ${failCount}/10\n`;
            contentDiv.textContent += `å¹³å‡å“åº”: ${Math.round(elapsed / 10)}ms\n`;
            
            if (successCount === 10) {
                resultDiv.className = 'result-area success';
                contentDiv.textContent += '\nâœ… å¹¶å‘å¤„ç†èƒ½åŠ›ä¼˜ç§€ï¼';
            } else if (successCount > 5) {
                contentDiv.textContent += '\nâš ï¸ éƒ¨åˆ†è¯·æ±‚å¤±è´¥ï¼Œå¯èƒ½è§¦å‘é€Ÿç‡é™åˆ¶';
            } else {
                resultDiv.className = 'result-area error';
                contentDiv.textContent += '\nâŒ å¹¶å‘å¤„ç†å­˜åœ¨é—®é¢˜';
            }
        }
        
        // å‹åŠ›æµ‹è¯•
        async function runStressTest() {
            const resultDiv = document.getElementById('performanceResult');
            const contentDiv = document.getElementById('performanceContent');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result-area';
            contentDiv.textContent = 'è¿è¡Œå‹åŠ›æµ‹è¯•...\n\n';
            
            const styles = ['humorous', 'educational', 'emotional', 'professional'];
            const lengths = [100, 500, 1000, 1500];
            
            for (let i = 0; i < 4; i++) {
                const script = 'è¿™æ˜¯æµ‹è¯•è„šæœ¬å†…å®¹ã€‚'.repeat(Math.floor(lengths[i] / 18));
                const style = styles[i];
                
                const startTime = Date.now();
                
                try {
                    const response = await fetch(`${getApiUrl()}/api/tongyi/script-rewrite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${getApiKey()}`
                        },
                        body: JSON.stringify({
                            original_script: script.substring(0, lengths[i]),
                            style: style
                        })
                    });
                    
                    const data = await response.json();
                    const elapsed = Date.now() - startTime;
                    
                    const status = elapsed < 8000 ? 'âœ…' : 'âš ï¸';
                    contentDiv.textContent += `${status} ${lengths[i]}å­—-${style}: ${elapsed}ms\n`;
                } catch (error) {
                    contentDiv.textContent += `âŒ ${lengths[i]}å­—-${style}: å¤±è´¥\n`;
                }
                
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            contentDiv.textContent += '\nå‹åŠ›æµ‹è¯•å®Œæˆï¼';
        }
        
        // æ˜¾ç¤ºæ€§èƒ½å›¾è¡¨
        function showPerformanceChart(results) {
            const chartDiv = document.getElementById('performanceChart');
            const barDiv = document.getElementById('perfBar');
            
            chartDiv.style.display = 'block';
            barDiv.innerHTML = '';
            
            const maxTime = Math.max(...results.map(r => r.time));
            
            results.forEach(result => {
                const percentage = (result.time / maxTime) * 100;
                const segment = document.createElement('div');
                segment.className = 'performance-segment';
                segment.style.width = percentage + '%';
                
                if (result.time < 3000) {
                    segment.classList.add('segment-good');
                } else if (result.time < 5000) {
                    segment.classList.add('segment-warning');
                } else {
                    segment.classList.add('segment-bad');
                }
                
                segment.textContent = `${result.time}ms`;
                barDiv.appendChild(segment);
            });
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            updateStatus(false, 'å‡†å¤‡å°±ç»ª');
            testConnection();
        };
    </script>
</body>
</html>