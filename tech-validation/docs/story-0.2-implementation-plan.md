# Story 0.2 å®æ–½è®¡åˆ’ - è§†é¢‘è½¬æ–‡å­—ç¼–æ’æœåŠ¡ï¼ˆå¢å¼ºç‰ˆï¼‰

## ä¸€ã€Story æ¦‚è¿°

**Story ID**: 0.2  
**Story åç§°**: è§†é¢‘è½¬æ–‡å­—ç¼–æ’æœåŠ¡  
**ä¼˜å…ˆçº§**: P0  
**é¢„è®¡å·¥æœŸ**: 5ä¸ªå·¥ä½œæ—¥  

## äºŒã€æŠ€æœ¯æ¶æ„ï¼ˆè°ƒæ•´ç‰ˆï¼‰

### 2.1 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·è¾“å…¥ 
  â†“
[é”™è¯¯è¾¹ç•Œ] â†’ é“¾æ¥æ¸…æ´—(RobustDouyinExtractor)
  â†“
[ç›‘æ§ç‚¹1] â†’ TikHubè§£æ(å¸¦é™çº§ç­–ç•¥)
  â†“
[ç›‘æ§ç‚¹2] â†’ äº‘çŒ«è½¬ç (å¸¦é™çº§ç­–ç•¥)
  â†“
[ç›‘æ§ç‚¹3] â†’ AIè„šæœ¬ç”Ÿæˆ(å¯é…ç½®Prompt)
  â†“
[ç›‘æ§ç‚¹4] â†’ ç»“æœè¾“å‡º
```

### 2.2 æœåŠ¡ä¾èµ–

| æœåŠ¡å±‚çº§ | ä¸»æœåŠ¡ | å¤‡ç”¨æœåŠ¡1 | å¤‡ç”¨æœåŠ¡2 | é™çº§æ–¹æ¡ˆ |
|---------|--------|-----------|-----------|----------|
| è§†é¢‘è§£æ | TikHub-Web | TikHub-App | æœ¬åœ°è§£æ | åŸURL |
| éŸ³é¢‘è½¬æ–‡å­— | äº‘çŒ«è½¬ç  | MiniMax | é˜¿é‡Œäº‘ | æ¨¡æ‹Ÿæ•°æ® |
| è„šæœ¬ç”Ÿæˆ | é€šä¹‰åƒé—® | MiniMax | è§„åˆ™å¼•æ“ | åŸºç¡€è„šæœ¬ |

## ä¸‰ã€å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆDay 1-2ï¼‰

#### 1.1 é”™è¯¯å¤„ç†ç³»ç»Ÿ
- [x] åˆ›å»ºé”™è¯¯ç±»å‹ç³»ç»Ÿ `error-types.ts`
- [ ] é›†æˆåˆ°ç°æœ‰ä»£ç 
- [ ] æ·»åŠ é”™è¯¯æ—¥å¿—æ”¶é›†

#### 1.2 æœåŠ¡é™çº§ç­–ç•¥
- [x] åˆ›å»ºé™çº§ç­–ç•¥ç®¡ç†å™¨ `fallback-strategy.ts`
- [ ] å®ç°å…·ä½“é™çº§æ–¹æ³•
- [ ] æ·»åŠ ç†”æ–­æœºåˆ¶

#### 1.3 ç›‘æ§ç³»ç»Ÿ
- [x] åˆ›å»ºè½»é‡çº§ç›‘æ§ `monitoring.ts`
- [ ] é›†æˆç›‘æ§ç‚¹
- [ ] é…ç½®é‡‡æ ·ç­–ç•¥

### Phase 2: æœåŠ¡é›†æˆï¼ˆDay 2-3ï¼‰

#### 2.1 TikHub é›†æˆ
```typescript
// å®ç°ä»»åŠ¡æ¸…å•
- [ ] å®Œæˆ TikHub å®¢æˆ·ç«¯æµ‹è¯•
- [ ] å®ç° Web API è°ƒç”¨
- [ ] å®ç° App API é™çº§
- [ ] æ·»åŠ æœ¬åœ°è§£æå¤‡ä»½
- [ ] é›†æˆç›‘æ§å’Œé”™è¯¯å¤„ç†
```

#### 2.2 äº‘çŒ«è½¬ç ä¼˜åŒ–
```typescript
// å®ç°ä»»åŠ¡æ¸…å•
- [ ] æ·»åŠ å¥åº·æ£€æŸ¥
- [ ] å®ç°è¶…æ—¶æ§åˆ¶
- [ ] é…ç½®é‡è¯•ç­–ç•¥
- [ ] é›†æˆé™çº§åˆ° MiniMax
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§
```

#### 2.3 Prompt æ¨¡æ¿ç³»ç»Ÿ
```typescript
// å®ç°ä»»åŠ¡æ¸…å•
- [ ] åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿
- [ ] å®ç°æ¨¡æ¿åŠ è½½æœºåˆ¶
- [ ] åˆ›å»ºæ¨¡æ¿æ¸²æŸ“å™¨
- [ ] æ·»åŠ æ¨¡æ¿éªŒè¯
- [ ] é¢„ç•™ç®¡ç†æ¥å£
```

### Phase 3: API ç«¯ç‚¹å‡çº§ï¼ˆDay 3-4ï¼‰

#### 3.1 transcribe-v3 ç«¯ç‚¹
```typescript
// æ–°å»ºæ”¯æŒå®Œæ•´é”™è¯¯å¤„ç†çš„ç«¯ç‚¹
export async function transcribeV3(req: Request): Promise<Response> {
  const monitor = monitoring.startSpan('video.transcribe');
  
  try {
    // 1. è¾“å…¥éªŒè¯ï¼ˆå¸¦é”™è¯¯ç±»å‹ï¼‰
    const input = await validateInput(req);
    
    // 2. é“¾æ¥æå–ï¼ˆå¸¦ç›‘æ§ï¼‰
    const videoUrl = await extractVideoUrl(input);
    
    // 3. è§†é¢‘è§£æï¼ˆå¸¦é™çº§ï¼‰
    const realUrl = await fallbackManager.resolveVideoWithFallback(videoUrl);
    
    // 4. éŸ³é¢‘è½¬æ–‡å­—ï¼ˆå¸¦é™çº§ï¼‰
    const transcript = await fallbackManager.transcribeWithFallback(realUrl);
    
    // 5. è„šæœ¬ç”Ÿæˆï¼ˆå¸¦æ¨¡æ¿ï¼‰
    const script = await generateScriptWithTemplate(transcript);
    
    monitoring.endSpan(monitor, 'success');
    return success(script);
    
  } catch (error) {
    monitoring.endSpan(monitor, 'error', error);
    return handleError(error);
  }
}
```

### Phase 4: æµ‹è¯•ä¸éƒ¨ç½²ï¼ˆDay 4-5ï¼‰

#### 4.1 å•å…ƒæµ‹è¯•
```typescript
// æµ‹è¯•è¦†ç›–
- [ ] é”™è¯¯ç±»å‹æµ‹è¯•
- [ ] é™çº§ç­–ç•¥æµ‹è¯•
- [ ] ç›‘æ§é‡‡æ ·æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
```

#### 4.2 æ€§èƒ½æµ‹è¯•
```typescript
// æ€§èƒ½æŒ‡æ ‡
- [ ] API å“åº”æ—¶é—´ < 30s
- [ ] é™çº§åˆ‡æ¢æ—¶é—´ < 2s
- [ ] ç›‘æ§å¼€é”€ < 5%
- [ ] å¹¶å‘å¤„ç† > 20
```

## å››ã€é…ç½®ç®¡ç†

### 4.1 ç¯å¢ƒå˜é‡
```env
# æœåŠ¡é…ç½®
TIKHUB_API_TOKEN=xxx
TIKHUB_PREFER_GUEST=true
YUNMAO_API_KEY=xxx
TONGYI_API_KEY=xxx

# é™çº§é…ç½®
FALLBACK_MAX_FAILURES=3
FALLBACK_RESET_TIMEOUT=60000
FALLBACK_ERROR_THRESHOLD=0.5

# ç›‘æ§é…ç½®
MONITORING_SAMPLE_RATE=0.1
MONITORING_FLUSH_INTERVAL=5000
```

### 4.2 åŠŸèƒ½å¼€å…³
```typescript
const FeatureFlags = {
  USE_TIKHUB: true,
  ENABLE_FALLBACK: true,
  ENABLE_MONITORING: true,
  USE_MOCK_IN_DEV: true
};
```

## äº”ã€é£é™©æ§åˆ¶

### 5.1 æŠ€æœ¯é£é™©
| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| TikHub API å˜æ›´ | é«˜ | å¤šç‰ˆæœ¬APIæ”¯æŒ |
| äº‘çŒ«é…é¢è€—å°½ | ä¸­ | è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨æœåŠ¡ |
| ç½‘ç»œä¸ç¨³å®š | ä¸­ | é‡è¯•+è¶…æ—¶æ§åˆ¶ |

### 5.2 è¿è¥é£é™©
| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| APIæˆæœ¬è¶…æ”¯ | é«˜ | é…é¢ç›‘æ§+å‘Šè­¦ |
| æœåŠ¡å•†æ•…éšœ | é«˜ | å¤šæœåŠ¡å•†å¤‡ä»½ |

## å…­ã€ç›‘æ§æŒ‡æ ‡

### 6.1 ä¸šåŠ¡æŒ‡æ ‡
- è§†é¢‘å¤„ç†æˆåŠŸç‡
- å¹³å‡å¤„ç†æ—¶é—´
- é™çº§è§¦å‘æ¬¡æ•°
- APIè°ƒç”¨æˆæœ¬

### 6.2 æŠ€æœ¯æŒ‡æ ‡
- æœåŠ¡å¯ç”¨æ€§
- P95å“åº”æ—¶é—´
- é”™è¯¯ç‡åˆ†å¸ƒ
- èµ„æºä½¿ç”¨ç‡

## ä¸ƒã€äº¤ä»˜æ ‡å‡†

### 7.1 åŠŸèƒ½è¦æ±‚
- [x] æ”¯æŒæŠ–éŸ³è§†é¢‘è½¬æ–‡å­—
- [x] æ”¯æŒå¤šæœåŠ¡å•†é™çº§
- [x] æ”¯æŒé”™è¯¯è‡ªåŠ¨æ¢å¤
- [x] æ”¯æŒæ€§èƒ½ç›‘æ§

### 7.2 éåŠŸèƒ½è¦æ±‚
- [x] å¯ç”¨æ€§ > 99.5%
- [x] å“åº”æ—¶é—´ < 30ç§’
- [x] å¹¶å‘æ”¯æŒ > 20
- [x] ç›‘æ§è¦†ç›–ç‡ > 80%

## å…«ã€åç»­ä¼˜åŒ–

1. **Phase 2.1**: æ·»åŠ æ›´å¤šè§†é¢‘å¹³å°æ”¯æŒ
2. **Phase 2.2**: å®ç°æ™ºèƒ½è·¯ç”±ï¼ˆåŸºäºæˆåŠŸç‡ï¼‰
3. **Phase 2.3**: æ·»åŠ ç»“æœç¼“å­˜å±‚
4. **Phase 2.4**: å®ç°ç®¡ç†åå°

## ä¹ã€ä»£ç ç»“æ„

```
tech-validation/
â”œâ”€â”€ clients/
â”‚   â”œâ”€â”€ tikhub-client.ts          âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ yunmao-client.ts          âœ… å·²åˆ›å»º
â”‚   â””â”€â”€ minimax-client-v2.ts      âœ… å·²å­˜åœ¨
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ fallback-strategy.ts      âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ prompt-template-manager.ts âœ… å·²åˆ›å»º
â”‚   â””â”€â”€ transcription-provider-manager.ts âœ… å·²å­˜åœ¨
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ error-types.ts            âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ monitoring.ts             âœ… å·²åˆ›å»º
â”‚   â””â”€â”€ robust-douyin-extractor.ts âœ… å·²å­˜åœ¨
â””â”€â”€ api/
    â””â”€â”€ video/
        â”œâ”€â”€ transcribe-v2.ts      âœ… å·²å­˜åœ¨
        â””â”€â”€ transcribe-v3.ts      â³ å¾…åˆ›å»º
```

---

**çŠ¶æ€**: ğŸš€ Ready for Implementation  
**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 1 çš„é›†æˆå·¥ä½œ