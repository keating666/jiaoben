# 四级权限系统设计文档

## 权限角色定义

### 1. C端用户 (customer)
**角色描述**: 平台的内容创作者和消费者
**安全等级**: 基础级

#### 权限清单:
- ✅ 输入激活码，激活正式用户状态
- ✅ 自主注册，非管理员录入线索，非销售员录入线索的客户，可查看到客服微信的引导信息
- ✅ 个人脚本管理 (创建、查看、删除自己的脚本)
- ✅ AI仿爆款脚本生成功能
- ✅ 个人资料管理
- ✅ IP诊断报告查看
- ✅ 兑换码使用
- ✅ 个人数据导出（脚本、ip报告）
- ✅ 查看管理员发送的通知
- ❌ 其他用户数据访问
- ❌ 系统配置访问
- ❌ 后台管理功能

---

### 2. 销售人员 (sales)
**角色描述**: 负责客户服务、产品演示和销售支持
**安全等级**: 受限级

#### 权限清单:
- ✅ 销售看板：试用转化率、客户状态分布、线索跟进状态等
- ✅ 销售线索查看（支持筛选按状态）
- ✅ 手动新增线索（需姓名+手机号，自动归属当前销售）
- ✅ 使用试用码为用户开启试用
- ✅ 使用激活码为用户开启正式服务
- ✅ 指定客户基本信息查看 (脱敏)
- ✅ 演示用IP诊断报告生成
- ✅ AI仿爆款脚本生成功能
- ✅ 客户对平台各项功能使用情况统计查看
- ✅ 试用码和激活码的申领与使用情况
- ✅ 销售数据看板访问
- ✅ 客户反馈查看
- ✅ 查看管理员发送的通知
- ✅ 对于“已过期”的用户，平台可以设置推送或提醒机制，销售人员可收到“过期未续费”用户清单，方便再营销
- ❌ 客户敏感信息访问 (密码、完整手机号等)
- ❌ 系统配置修改
- ❌ 用户管理操作
- ❌ 兑换码生成

---

### 3. 管理员 (admin)
**角色描述**: 负责平台日常运营管理，不涉及系统核心配置
**安全等级**: 运营级

#### 权限清单:
##### 用户管理
- ✅ 销售线索批量导入与批量分配（CSV，需模板）
- ✅ 销售线索单个录入与单个分配
- ✅ 配置客服微信二维码（上传二维码图片，有效期管理）
- ✅ 用户列表查看和筛选
- ✅ 销售人员账户创建
- ✅ 用户基本信息编辑 (非敏感信息)
- ✅ 用户状态管理 (启用/禁用)
- ✅ 用户标签管理
- ✅ 用户密码重置
- ✅ 给销售人员、C用户发送通知
- ❌ 用户手机号修改
- ❌ 超级管理员账号操作

##### 内容管理
- ✅ 脚本推荐和置顶
- ✅ 设置 IP 诊断报告的模板(初期单一版本，未来多版本)
- ✅ 内容分类管理
- ✅ 热点话题配置

##### 试用码/激活码管理
- ✅ 管理试用码/激活码池（生成、作废、分配、使用记录）
- ✅ 试用码/激活码批量生成
- ✅ 试用码/激活码使用情况查看
- ✅ 试用码/激活码状态管理
- ✅ 兑试用码/激活码批次管理
- ❌ 试用码/激活码策略配置

##### 数据分析
- ✅ 运营数据看板
- ✅ 用户行为分析
- ✅ 内容使用统计
- ✅ 满意度数据分析
- ✅ 导出运营报告

##### 系统维护 (受限)
- ❌ 系统参数配置
- ❌ API密钥管理
- ❌ 数据库直接操作
- ❌ 服务器配置

---

### 4. 超级管理员 (super_admin)
**角色描述**: 拥有全部权限，负责系统安全和核心配置
**安全等级**: 最高级

#### 权限清单:
##### 继承所有普通管理员权限 + 以下额外权限:

##### 系统配置
- ✅ AI服务配置和密钥管理（不同AI功能模块配置不同ai服务商，一主一备）
- ✅ 数据库连接配置
- ✅ 缓存策略配置
- ✅ 定时任务配置
- ✅ 限流规则配置
- ✅ 安全策略配置

##### 用户安全管理
- ✅ 所有用户密码重置
- ✅ 用户手机号修改
- ✅ 管理员账号创建/删除
- ✅ 权限角色分配
- ✅ 登录日志查看
- ✅ 异常行为监控

##### 系统维护
- ✅ 系统参数调优
- ✅ 数据库维护操作
- ✅ 服务器状态监控
- ✅ 备份策略管理
- ✅ 日志系统配置

##### 审计和安全
- ✅ 操作日志查看
- ✅ 安全事件处理
- ✅ 系统漏洞管理
- ✅ 权限变更审批

—--

## 功能模块说明

### 短视频仿写模块
客户输入抖音短视频链接，后台下载短视频，使用ffmpeg生成音频，调用AI频识成文字，文字交给AI按照设定提示词重新生成分镜头脚本，脚本呈现在客户web端

### 用户生命周期管理

#### 用户生命周期状态设计：6个状态
1. 未注册线索
- 录入了用户信息，但用户尚未完成注册（手机号未验证），可能来源于销售人员手动录入或管理员批量导入。
2. 待激活用户
- 已完成注册（手机号+验证码），但尚未激活试用码或正式激活码。
3. 试用中
- 销售人员使用试用码为其开启试用，试用期为3天，可每日使用一次仿写功能。
4. 已激活
- 使用正式激活码（30天）激活，无论是用户自主操作还是销售人员后台操作。
5. 已过期
- 试用期（3天）或正式激活期（30天）过期后，自动进入“已过期”状态。
6. 自主注册待分配
- 用户通过手机号注册，但尚未被分配销售人员。需要引导其添加客服微信，分配销售员服务。


#### 激活码机制说明
1. 试用码:开启试用（生成IP诊断报告 + 每日1条脚本）3天 销售人员激活
2. 正式激活码：开启完整服务权限（每日脚本、推荐算法、保存历史） 30天 销售人员激活 或 用户自主输入
    * 激活码均由系统管理员统一生成和分发，使用后标记为“已用”。
	*	试用码可在销售人员后台选择用户并使用（支持新建或已存在用户）。
	*	激活码使用后将用户状态更新为“已激活”。

#### 用户路径流程梳理

场景1：销售主导引导路径
	1.	销售人员手动录入线索（姓名+手机号） → 状态为“未注册”
	2.	用户收到销售引导，使用手机号注册 → 状态变为“待激活”
	3.	销售人员在后台使用试用码 → 状态变为“试用中”（生成IP报告）
	4.	试用3天后，如未激活 → 状态变为“已过期”
	5.	激活码输入后 → 状态变为“已激活”，计时30天

场景2：用户自主注册路径
	1.	用户访问平台，自主使用手机号注册 → 状态为“待激活”
	2.	系统提示“如需服务请添加客服微信”（二维码来自管理员配置）
	3.	客服获取用户信息 → 管理员录入后台并分配销售人员
	4.	后续同“销售主导路径”一致

#### 
---

## 权限实现机制

### 1. 角色优先级
```
super_admin > admin > sales > customer
```

### 2. 权限检查流程
```javascript
// 权限检查中间件
const checkPermission = (requiredRole, requiredPermission) => {
  return (req, res, next) => {
    const userRole = req.user.role;
    const userPermissions = getRolePermissions(userRole);
    
    // 超级管理员拥有所有权限
    if (userRole === 'super_admin') {
      return next();
    }
    
    // 检查角色等级
    if (!checkRoleLevel(userRole, requiredRole)) {
      return res.status(403).json({ message: '权限不足' });
    }
    
    // 检查具体权限
    if (!userPermissions.includes(requiredPermission)) {
      return res.status(403).json({ message: '没有此操作权限' });
    }
    
    next();
  };
};
```

### 3. 前端权限控制
```javascript
// 基于角色的组件渲染
<PermissionGuard role="admin" permission="user:manage">
  <UserManagement />
</PermissionGuard>

// 基于角色的菜单显示
const getMenuItems = (userRole) => {
  switch(userRole) {
    case 'super_admin':
      return [...adminMenus, ...systemMenus];
    case 'admin':
      return adminMenus;
    case 'sales':
      return salesMenus;
    default:
      return customerMenus;
  }
};
```

---

## 安全边界设计

### 1. 数据隔离
- **物理隔离**: 敏感配置单独存储
- **逻辑隔离**: 用户数据按角色分级访问
- **时间隔离**: 敏感操作需要额外验证

### 2. 操作审计
- **所有管理员操作记录**
- **敏感操作实时告警**
- **权限变更邮件通知**
- **异常登录行为监控**

### 3. 访问控制
- **IP白名单** (超级管理员可配置)
- **时间窗口限制** (非工作时间限制敏感操作)
- **多因素认证** (管理员级别以上必须)
- **会话超时** (不同角色不同超时时间)

---

## 实施建议

### 阶段1: 权限分离 (立即)
1. 修改用户表添加角色字段
2. 实现权限检查中间件
3. 更新API接口权限验证

### 阶段2: 界面适配 (1周内)
1. 前端菜单权限控制
2. 页面级权限验证
3. 按钮级权限隐藏

### 阶段3: 安全加固 (2周内)
1. 操作日志记录
2. 异常行为监控
3. 多因素认证

### 阶段4: 审计完善 (1个月内)
1. 完整审计日志
2. 安全事件响应
3. 权限定期审查