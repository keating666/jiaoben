# Story 0.4: Configure Vercel Environment Variables

## Status
Draft

## Story
**As a** DevOps engineer,
**I want** to securely configure and manage environment variables in Vercel,
**so that** our API endpoints can access necessary credentials without exposing sensitive information

## Acceptance Criteria
1. All required API keys are configured in Vercel project settings
2. Environment variables are properly scoped (production, preview, development)
3. Create a comprehensive environment variable documentation
4. Implement environment variable validation on application startup
5. Set up a secure process for rotating API keys
6. Configure monitoring for API key usage and limits
7. Ensure zero downtime during environment variable updates

## Tasks / Subtasks
- [ ] **Task 1: Document all required environment variables** (AC: 3)
  - [ ] Create comprehensive list of all env variables
  - [ ] Document purpose and format for each variable
  - [ ] Specify which are required vs optional
  - [ ] 记录第一阶段必需的环境变量
  - [ ] 记录第二阶段预留的环境变量（注明对应的故事编号）
  - [ ] 在文档中明确标注实施阶段
  - [ ] Create .env.example with all variables
  - [ ] Document environment-specific variations
  
- [ ] **Task 2: Configure variables in Vercel dashboard** (AC: 1, 2)
  - [ ] Add MiniMax API credentials (API_KEY, GROUP_ID)
  - [ ] Add Tongyi API credentials (API_KEY, MODEL)
  - [ ] Add application-specific variables (JWT_SECRET, etc.)
  - [ ] Configure proper scoping for each environment
  - [ ] Verify variables are accessible in functions
  
- [ ] **Task 3: Implement startup validation** (AC: 4)
  - [ ] Create env validation utility function
  - [ ] Check all required variables on startup
  - [ ] Provide clear error messages for missing variables
  - [ ] Log successful validation (without values)
  - [ ] Implement graceful shutdown on validation failure
  
- [ ] **Task 4: Set up key rotation process** (AC: 5, 7)
  - [ ] Document key rotation procedures
  - [ ] Create scripts for testing new keys
  - [ ] Implement gradual rollout strategy
  - [ ] Set up alerts for expiring keys
  - [ ] Create rollback procedures
  
- [ ] **Task 5: Implement usage monitoring** (AC: 6)
  - [ ] Add API call counting by key
  - [ ] Monitor rate limit approaching
  - [ ] Set up alerts for unusual usage patterns
  - [ ] Create dashboard for API usage metrics
  - [ ] Log quota warnings
  
- [ ] **Task 6: Security hardening** (AC: 1, 5)
  - [ ] Audit all environment variable access
  - [ ] Implement least privilege principle
  - [ ] Add environment variable encryption at rest
  - [ ] Create security incident response plan
  - [ ] Document security best practices

## Dev Notes

### Current Environment Variables
[Source: tech-validation/.env.example]
```bash
# === 第一阶段：API 集成（当前需要）===
# MiniMax API Configuration
MINIMAX_API_KEY=your_minimax_api_key
MINIMAX_GROUP_ID=your_minimax_group_id
MINIMAX_BASE_URL=https://api.minimax.chat/v1

# Tongyi (Qwen) API Configuration  
TONGYI_API_KEY=your_tongyi_api_key
TONGYI_BASE_URL=https://dashscope.aliyuncs.com/api/v1
TONGYI_MODEL=qwen-max

# IFlytek API Configuration (备用)
IFLYTEK_APP_ID=your_iflytek_app_id
IFLYTEK_API_KEY=your_iflytek_api_key
IFLYTEK_API_SECRET=your_iflytek_api_secret

# Application Configuration
NODE_ENV=development
API_RATE_LIMIT=100
API_TIMEOUT=30000
ENABLE_CACHE=true
CACHE_TTL=3600

# === 第二阶段：用户系统（Story 1.2 需要）===
# JWT_SECRET=your_jwt_secret_key (待 Story 1.2 实施时配置)
# API_KEY_SALT=your_api_key_salt (待实施 API 密钥管理时配置)
```

### Vercel Environment Variable Configuration
[Source: Vercel documentation]
1. Navigate to Project Settings > Environment Variables
2. Add variables with proper scoping:
   - Production: Live application
   - Preview: Pull request deployments
   - Development: Local development

### Environment Variable Validation Utility
```typescript
// utils/env-validator.ts
export const envConfig = {
  phase1: {
    required: [
      'MINIMAX_API_KEY',
      'MINIMAX_GROUP_ID',
      'TONGYI_API_KEY'
    ],
    optional: [
      'IFLYTEK_APP_ID',
      'IFLYTEK_API_KEY',
      'IFLYTEK_API_SECRET',
      'MINIMAX_BASE_URL',
      'TONGYI_BASE_URL',
      'TONGYI_MODEL'
    ]
  },
  phase2: {
    required: [
      'JWT_SECRET',
      'API_KEY_SALT'
    ]
  }
};

export function validateEnv(phase: 'phase1' | 'phase2' = 'phase1'): void {
  const config = envConfig[phase];
  const errors: string[] = [];
  
  // Check required variables
  for (const key of config.required) {
    if (!process.env[key]) {
      errors.push(`Missing required env variable: ${key}`);
    }
  }
  
  if (errors.length > 0) {
    throw new Error(`Environment validation failed:\n${errors.join('\n')}`);
  }
}

// 当前只验证 phase1
validateEnv('phase1');
```

### Key Rotation Strategy
[Source: Security best practices]
1. **Preparation Phase**
   - Generate new API keys from providers
   - Test new keys in development environment
   - Update preview environment variables

2. **Rollout Phase**
   - Deploy to preview with new keys
   - Monitor for errors (15 minutes)
   - Update production environment variables
   - Deploy to production

3. **Cleanup Phase**
   - Monitor production (24 hours)
   - Revoke old API keys
   - Update documentation

### Monitoring Implementation
```typescript
// utils/api-monitor.ts
interface ApiUsage {
  provider: string;
  endpoint: string;
  timestamp: number;
  responseTime: number;
  statusCode: number;
  quotaRemaining?: number;
}

export class ApiMonitor {
  private static usage: Map<string, ApiUsage[]> = new Map();
  
  static logUsage(usage: ApiUsage): void {
    // Implementation for tracking API usage
    // Send to monitoring service (e.g., Vercel Analytics)
  }
  
  static checkQuota(provider: string): void {
    // Check if approaching rate limits
    // Send alerts if necessary
  }
}
```

### Security Considerations
- Never log environment variable values
- Use Vercel's built-in encryption for sensitive values
- Implement audit logging for all API key access
- Regular security reviews of environment variables
- Use separate keys for each environment

## Testing
### Testing Standards
- Test application startup with missing variables
- Verify graceful degradation with invalid keys
- Test key rotation without downtime
- Validate all error messages are user-friendly
- Ensure no sensitive data in logs

### Verification Checklist
- [ ] All functions can access required env variables
- [ ] Preview deployments use preview variables
- [ ] Production uses production variables
- [ ] No hardcoded credentials in codebase
- [ ] Environment validation runs on cold start

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-23 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated after implementation_