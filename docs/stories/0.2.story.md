# Story 0.2: 实现视频转文字编排服务

## Status
Draft

## Story
**As a** 系统开发者,
**I want** 实现一个完整的视频转分镜头脚本服务,
**so that** 用户可以通过提供视频URL获得AI生成的分镜头脚本

## Acceptance Criteria
1. 创建 `/api/video/transcribe` 端点，接受视频URL并返回分镜头脚本
2. 使用 yt-dlp 下载视频文件到临时目录
3. 使用 ffmpeg 从视频中提取音频
4. 使用 MiniMax API 将音频转换为文字
5. 使用通义千问 API 将文字转化为分镜头脚本
6. 实现完整的错误处理和用户友好的错误信息
7. 视频时长限制在60秒内，超时返回明确提示
8. 临时文件在处理完成后自动清理
9. 整个处理流程在 Vercel Functions 60秒限制内完成

## Tasks / Subtasks
- [ ] **Task 1: 创建视频转文字编排服务端点** (AC: 1)
  - [ ] 创建 api/video/transcribe.ts 文件
  - [ ] 设置 TypeScript 类型定义
  - [ ] 配置 Vercel Functions 导出
  
- [ ] **Task 2: 配置二进制依赖** (AC: 2, 3)
  - [ ] 在 Vercel 环境配置 yt-dlp 二进制文件
  - [ ] 在 Vercel 环境配置 ffmpeg 二进制文件
  - [ ] 创建依赖检查函数，确保二进制文件可用
  - [ ] 配置临时文件目录路径（/tmp）
  
- [ ] **Task 3: 实现视频下载和音频提取** (AC: 2, 3, 7, 8)
  - [ ] 解析请求中的视频URL
  - [ ] 使用 yt-dlp 获取视频元数据（验证时长）
  - [ ] 如果时长超过60秒，直接返回错误
  - [ ] 使用 yt-dlp 下载视频到 /tmp 目录
  - [ ] 使用 ffmpeg 提取音频（mp3格式）
  - [ ] 实现临时文件清理机制
  
- [ ] **Task 4: 实现音频转文字** (AC: 4)
  - [ ] 调用 MiniMax API 客户端
  - [ ] 传递音频文件进行语音识别
  - [ ] 处理 API 响应和错误
  - [ ] 返回转写的文字内容
  
- [ ] **Task 5: 实现分镜头脚本生成** (AC: 5)
  - [ ] 构建分镜头脚本生成的 prompt
  - [ ] 调用通义千问 API
  - [ ] 将原始文字转换为结构化的分镜头脚本
  - [ ] 格式化输出结果
  
- [ ] **Task 6: 错误处理和响应** (AC: 6, 7, 9)
  - [ ] 实现统一的错误处理中间件
  - [ ] 返回用户友好的错误信息
  - [ ] 添加超时处理（50秒警告）
  - [ ] 记录处理时间和性能指标
  

## Dev Notes

### Vercel Serverless Function Structure
[Source: Vercel documentation]
```typescript
// api/minimax/speech-to-text.ts
import { VercelRequest, VercelResponse } from '@vercel/node';

export default async function handler(
  req: VercelRequest,
  res: VercelResponse
) {
  // Implementation
}
```

### Existing MiniMax Client
[Source: tech-validation/scripts/minimax-client-v2.ts]
- Enhanced client with retry logic and circuit breaker
- Supports both text generation and speech-to-text
- Configuration via environment variables
- Built-in performance monitoring

### Required Environment Variables
[Source: tech-validation/.env.example]
```
MINIMAX_API_KEY=your_api_key
MINIMAX_GROUP_ID=your_group_id
MINIMAX_BASE_URL=https://api.minimax.chat/v1
```

### API 端点规范

#### 视频转分镜头脚本端点
```
POST /api/video/transcribe
Content-Type: application/json

Request:
{
  "video_url": string (required, 视频链接),
  "style": string (optional, 脚本风格: "default" | "humorous" | "professional"),
  "language": string (optional, default: "zh")
}

Response (成功):
{
  "success": true,
  "data": {
    "original_text": string (原始转写文字),
    "script": {
      "title": string (建议标题),
      "duration": number (视频时长-秒),
      "scenes": [
        {
          "scene_number": number,
          "timestamp": string (时间戳 "00:00-00:10"),
          "description": string (场景描述),
          "dialogue": string (对话/旁白),
          "notes": string (拍摄建议)
        }
      ]
    },
    "processing_time": number (处理耗时-毫秒)
  }
}

Response (失败):
{
  "success": false,
  "error": {
    "code": string,
    "message": string,
    "details": object (optional)
  }
}
```

### Security Considerations
[Source: Architecture security requirements]
- API keys must be validated on every request
- Rate limiting: 100 requests per minute per API key
- Request size limits enforced by Vercel (5MB default)
- All errors must be sanitized before returning to client

### 错误响应格式
```typescript
// 视频处理错误响应示例
{
  "success": false,
  "error": {
    "code": "VIDEO_TOO_LONG",
    "message": "视频时长超过60秒限制",
    "details": {
      "duration": 65.5,
      "limit": 60,
      "video_url": "https://example.com/video.mp4"
    }
  }
}

// 其他错误码
- INVALID_VIDEO_URL: 无效的视频链接
- VIDEO_DOWNLOAD_FAILED: 视频下载失败
- UNSUPPORTED_FORMAT: 不支持的视频格式
- PROCESSING_FAILED: 视频处理失败
```

### 完整技术流程
```
客户端                     服务端处理流程
  │                           │
  ├─── 视频URL ──────────────→├─1.验证URL和获取元数据 (yt-dlp)
  │                           ├─2.检查视频时长 (<60秒)
  │                           ├─3.下载视频到/tmp (yt-dlp)
  │                           ├─4.提取音频 (ffmpeg)
  │                           ├─5.语音转文字 (MiniMax)
  │                           ├─6.生成分镜头脚本 (通义千问)
  │                           ├─7.清理临时文件
  │←─── 分镜头脚本 ───────────┤
```

### 二进制依赖配置
```bash
# 在 Vercel 构建时安装
# package.json 中添加 postinstall 脚本
"scripts": {
  "postinstall": "node scripts/install-binaries.js"
}

# install-binaries.js 示例
const { execSync } = require('child_process');
const fs = require('fs');

// 下载 yt-dlp
if (!fs.existsSync('./bin/yt-dlp')) {
  execSync('mkdir -p ./bin');
  execSync('curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o ./bin/yt-dlp');
  execSync('chmod +x ./bin/yt-dlp');
}

// ffmpeg 使用 @ffmpeg-installer/ffmpeg 包
```

### 分镜头脚本生成 Prompt 模板
```typescript
const scriptPrompt = `
请将以下视频转写文字改写为专业的分镜头脚本。

原始文字：
${transcribedText}

要求：
1. 分析内容，划分为多个镜头场景
2. 每个场景包含：场景编号、时间戳、场景描述、对话/旁白、拍摄建议
3. 整体风格：${style}
4. 输出格式为结构化的 JSON

示例输出格式：
{
  "title": "视频标题",
  "scenes": [
    {
      "scene_number": 1,
      "timestamp": "00:00-00:10",
      "description": "开场画面描述",
      "dialogue": "旁白或对话内容",
      "notes": "拍摄建议或特效说明"
    }
  ]
}
`;
```

### 性能要求
- 视频元数据获取: < 2 秒
- 视频下载 (60秒): < 10 秒
- 音频提取: < 3 秒
- 语音转文字: < 10 秒
- 分镜头脚本生成: < 5 秒
- 总处理时间: < 30 秒（留30秒余量）

## Testing
### Testing Standards
- Create integration tests using real API calls in development
- Mock MiniMax responses for unit tests
- Test error scenarios (invalid API key, rate limits, timeouts)
- Load test with concurrent requests
- Verify CORS headers for allowed origins

### Test Coverage Requirements
- All error paths must be tested
- Authentication failures must return 401
- Validation failures must return 400
- Server errors must return 500 with safe error messages

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-23 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record
### Agent Model Used
_To be populated during implementation_

### Debug Log References
_To be populated during implementation_

### Completion Notes List
_To be populated during implementation_

### File List
_To be populated during implementation_

## QA Results
_To be populated after implementation_